<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Territory CRM Pro (v15.0)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  html, body, #map { height:100%; margin:0; }

  /* Panel */
  #panel {
    position:fixed; top:20px; left:20px; z-index:9999; background:#fff;
    padding:0; border:1px solid #ccc; border-radius:10px;
    box-shadow:0 2px 6px rgba(0,0,0,0.15);
    font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    font-size:13px; width:360px; max-height:86vh; overflow:hidden;
  }
  #panelHeader {
    display:flex; align-items:center; justify-content:space-between;
    padding:8px 10px; border-bottom:1px solid #e6e6e6; background:#f7f7f9;
    cursor: move;
  }
  #panelHeader .badge { background:#ffe08a; color:#7a4d00; font-weight:700; padding:2px 6px; border-radius:6px; }
  #panelHeader .title { font-weight:700; font-size:14px; display:flex; align-items:center; gap:8px; }
  #btnCollapsePanel { cursor:pointer; border:1px solid #fff; border-radius:6px; background:#6a1b9a; padding:2px 6px; font-size:12px; }

  #panelBody { padding:12px; overflow:auto; max-height:calc(86vh - 40px); }
  #panel.is-collapsed #panelBody { display:none; }
  #panel.is-collapsed { max-height:unset; }

  /* Tabs for AI Tools */
  .tabs {
    display:flex; gap:4px; margin-bottom:12px; border-bottom:2px solid #e6e6e6;
  }
  .tab {
    padding:8px 12px; cursor:pointer; border-radius:8px 8px 0 0;
    background:#f0f0f3; transition:all 0.2s; font-weight:500;
  }
  .tab:hover { background:#e6e6e9; }
  .tab.active {
    background:#6a1b9a; color:#fff;
  }
  .tab-content { display:none; }
  .tab-content.active { display:block; }

  /* Status filter styling */
  .status-filter-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
  }
  
  .status-filter-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
  }
  
  .status-filter-item:hover {
    background: #f8f9fa;
    border-color: #6a1b9a;
    transform: translateY(-1px);
  }
  
  .status-filter-item input[type="checkbox"]:checked + .status-label {
    font-weight: 600;
    color: #6a1b9a;
  }
  
  .status-filter-item:has(input:checked) {
    background: #f0e6ff;
    border-color: #6a1b9a;
    border-width: 2px;
  }
  
  /* Fallback for browsers that don't support :has() */
  .status-filter-item.checked {
    background: #f0e6ff;
    border-color: #6a1b9a;
    border-width: 2px;
  }
  
  .status-filter-item input[type="checkbox"] {
    margin: 0;
  }
  
  .status-label {
    font-weight: 500;
    font-size: 12px;
    user-select: none;
    transition: all 0.2s ease;
  }

  /* Toggle switches for staff and stale contacts */
  .toggle-container {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 6px 0;
    font-size: 13px;
    cursor: pointer;
  }

  .toggle-slider {
    position: relative;
    width: 44px;
    height: 22px;
    background-color: #ccc;
    border-radius: 11px;
    transition: background-color 0.3s;
  }

  .toggle-slider::before {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 18px;
    height: 18px;
    background-color: white;
    border-radius: 50%;
    transition: transform 0.3s;
  }

  input[type="checkbox"]:checked + .toggle-slider {
    background-color: #6a1b9a;
  }

  input[type="checkbox"]:checked + .toggle-slider::before {
    transform: translateX(22px);
  }

  input[type="checkbox"] {
    display: none;
  }

  .toggle-label {
    font-weight: 500;
  }

  /* Insights Panel - always visible */
  #insightsPanel {
    position:fixed; top:20px; right:20px; z-index:9998;
    width:320px; background:#fff;
    border:1px solid #ccc; border-radius:10px;
    box-shadow:0 2px 6px rgba(0,0,0,0.15);
    font-family:system-ui, -apple-system, sans-serif;
    font-size:13px;
    transition: all 0.3s ease;
  }
  #insightsPanel.highlighted {
    box-shadow:0 0 12px rgba(106, 27, 154, 0.4);
    border-color:#6a1b9a;
  }
  #insightsHeader {
    display:flex; align-items:center; justify-content:space-between;
    padding:8px 10px; border-bottom:1px solid #e6e6e6; 
    background:#f7f7f9; border-radius:10px 10px 0 0;
    cursor: move;
  }
  #insightsHeader.has-update {
    background:linear-gradient(135deg, #f7f7f9 0%, #f0e6ff 100%);
  }
  #insightsBody {
    padding:12px; max-height:400px; overflow:auto;
  }
  #btnCollapseInsights {
    cursor:pointer; border:1px solid #fff; border-radius:6px; 
    background:#6a1b9a; padding:2px 6px; font-size:12px; color:#fff;
  }
  #insightsPanel.is-collapsed #insightsBody { display:none; }
  #insightsPanel.is-collapsed { max-height:unset; }

  /* Enhanced insight sections */
  .insight-section {
    background: white;
    margin-bottom: 15px;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .insight-section h4 {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 16px;
  }
  
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
  }
  
  .metric {
    text-align: center;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 6px;
  }
  
  .metric.staff-metric {
    background: #f0e6ff;
    border: 1px solid #800080;
  }
  
  .metric-value {
    display: block;
    font-size: 24px;
    font-weight: bold;
    color: #333;
    margin-bottom: 4px;
  }
  
  .metric-label {
    font-size: 12px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .status-breakdown, .follow-up-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .status-item, .follow-up-item {
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 4px;
    font-size: 14px;
  }
  
  .alert-section {
    background: #fff3cd;
    border-left: 4px solid #ff7f0e;
  }
  
  .quick-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  .quick-btn {
    padding: 8px 12px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .quick-btn:hover {
    background: #5a67d8;
    transform: translateY(-1px);
  }
  
  .more-items {
    font-size: 12px;
    color: #666;
    text-align: center;
    padding: 5px;
  }
  
  .tab-updated {
    background: #fff3cd !important;
    color: #856404 !important;
    animation: pulse 0.5s ease-in-out;
  }
  
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }
  
  /* AI Assistant Panel */
  #aiPanel {
    position:fixed; bottom:80px; right:20px; z-index:9997;
    width:320px; height:360px; background:#fff;
    border:1px solid #ccc; border-radius:10px;
    box-shadow:0 2px 6px rgba(0,0,0,0.15);
    font-family:system-ui, -apple-system, sans-serif;
    display:none; flex-direction:column;
    cursor: move;
  }
  #aiPanel.active { display:flex; }
  
  #aiHeader {
    display:flex; align-items:center; justify-content:space-between;
    cursor: move;
    padding:10px 14px; border-bottom:1px solid #e6e6e6;
    background:linear-gradient(135deg, #6a1b9a 0%, #8e24aa 100%);
    color:#fff; border-radius:10px 10px 0 0;
  }
  
  #aiChat {
    flex:1; overflow-y:auto; padding:12px;
    background:#f9f9fb;
  }
  
  .ai-message {
    margin:8px 0; padding:8px 12px; border-radius:12px;
    max-width:85%; word-wrap:break-word;
  }
  .ai-message.user {
    background:#6a1b9a; color:#fff; margin-left:auto;
    text-align:right;
  }
  .ai-message.assistant {
    background:#fff; border:1px solid #e0e0e0;
  }
  .ai-message.loading {
    background:#f0f8ff; border:1px solid #4CAF50; 
    animation: pulse 1.5s ease-in-out infinite alternate;
    font-style: italic;
  }
  .ai-message.error {
    background:#fff5f5; border:1px solid #f56565; color:#c53030;
  }
  @keyframes pulse {
    0% { opacity: 0.6; }
    100% { opacity: 1; }
  }
  
  .api-status {
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 4px;
    background: #f5f5f5;
    border: 1px solid #ddd;
    min-width: 20px;
    text-align: center;
    transition: all 0.3s ease;
  }
  .api-status.active {
    background: #d4edda;
    border-color: #4CAF50;
    color: #155724;
  }
  .api-status.inactive {
    background: #f8d7da;
    border-color: #f56565;
    color: #721c24;
  }
  
  #aiInputArea {
    padding:10px; border-top:1px solid #e6e6e6;
    display:flex; gap:8px;
  }
  
  #aiInput {
    flex:1; padding:8px; border:1px solid #ddd;
    border-radius:20px; font-size:13px;
  }
  
  #aiSend {
    padding:8px 16px; background:#6a1b9a; color:#fff;
    border:none; border-radius:20px; cursor:pointer;
    font-weight:500;
  }
  #aiSend:hover { background:#8e24aa; }
  
  /* AI Analysis Results */
  .ai-analysis-card {
    background:#fff; border:1px solid #e0e0e0;
    border-radius:8px; padding:10px; margin:8px 0;
  }
  .ai-stat {
    display:flex; justify-content:space-between;
    padding:4px 0; border-bottom:1px solid #f0f0f0;
  }
  .ai-stat:last-child { border-bottom:none; }
  .ai-recommendation {
    background:#f0f8ff; padding:8px; border-radius:6px;
    margin-top:8px; border-left:3px solid #1f77b4;
  }

  /* Brand buttons */
  button {
    background:#6a1b9a;
    color:#fff;
    border:none;
    border-radius:6px;
    padding:4px 8px;
    font-weight:500;
    cursor:pointer;
    transition:background .2s;
  }
  button:hover {
    background:#8e24aa;
  }
  button:disabled {
    background:#ccc;
    color:#666;
    cursor:default;
  }

  /* AI Toggle Button */
  #btnToggleAI {
    position:fixed; bottom:80px; right:20px; z-index:9999;
    width:56px; height:56px; border-radius:50%;
    background:linear-gradient(135deg, #6a1b9a 0%, #8e24aa 100%);
    color:#fff; border:none; box-shadow:0 3px 8px rgba(0,0,0,0.2);
    display:flex; align-items:center; justify-content:center;
    font-size:24px; cursor:pointer; transition:transform 0.2s;
  }
  #btnToggleAI:hover { transform:scale(1.1); }

  /* Legend */
  #legend {
    position:fixed; bottom:20px; left:20px; z-index:9998; background:#fff;
    padding:10px 12px; border:1px solid #ccc; border-radius:10px;
    box-shadow:0 2px 6px rgba(0,0,0,0.15); font-family:system-ui; font-size:13px;
  }
  .swatch{display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:6px;vertical-align:-2px;}
  .list-item{padding:6px 8px;border-bottom:1px solid #eee;cursor:pointer;}
  .list-item:hover{background:#f6f8fa;}
  .leaflet-interactive.territory-boundary{pointer-events:none;}
  .muted{color:#666;}
  .row{display:flex;gap:6px;}
  .row>*{flex:1;}
  .popup-row{margin-top:6px}
  .popup-row select{padding:2px 4px; font-size:12px;}
  
  /* Enhanced popup styling */
  .leaflet-popup-content {
    min-width:280px;
    max-width:380px;
  }
  
  .popup-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 15px;
    border-radius: 8px 8px 0 0;
    margin: -10px -10px 15px -10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .popup-header.staff-header {
    background: linear-gradient(135deg, #800080, #9932cc);
  }
  
  .popup-header h3 {
    margin: 0;
    font-size: 18px;
  }
  
  .group-badge {
    background: rgba(255,255,255,0.2);
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
  }
  
  .popup-content {
    max-height: 500px;
    overflow-y: auto;
  }
  
  .popup-section {
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
  }
  
  .popup-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
  }
  
  .popup-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 2px solid #eee;
  }
  
  .update-btn, .ai-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .update-btn {
    background: #2ca02c;
    color: white;
  }
  
  .update-btn:hover {
    background: #228B22;
    transform: translateY(-1px);
  }
  
  .ai-btn {
    background: #667eea;
    color: white;
  }
  
  .ai-btn:hover {
    background: #5a67d8;
    transform: translateY(-1px);
  }
  
  .popup-readonly {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 6px;
    text-align: center;
    margin-top: 15px;
    color: #666;
  }

  .leaflet-popup-content textarea {
    font-family:system-ui, -apple-system, sans-serif;
  }
  .leaflet-popup-content button[data-role="save-changes"] {
    background:#6a1b9a;
    color:#fff;
    border:none;
    border-radius:6px;
    padding:6px 12px;
    font-weight:500;
    cursor:pointer;
    font-size:13px;
    transition:background .2s;
  }
  .leaflet-popup-content button[data-role="save-changes"]:hover:not(:disabled) {
    background:#8e24aa;
  }
  .leaflet-popup-content button[data-role="save-changes"]:disabled {
    background:#ccc;
    color:#666;
    cursor:default;
  }
  .leaflet-popup-content button[data-role="add-timestamp"] {
    background:#f0f0f3;
    color:#333;
    border:1px solid #ddd;
    cursor:pointer;
    transition:background .2s;
  }
  .leaflet-popup-content button[data-role="add-timestamp"]:hover {
    background:#e6e6e9;
  }

  /* Toast */
  #toast {
    position:fixed;right:20px;bottom:20px;z-index:10000;
    padding:10px 12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.15);
    font:13px/1.3 system-ui;display:none;max-width:50vw;
  }

  /* Log (minimizable, doesn't cover legend) */
  #log {
    position:fixed; right:20px; bottom:150px; z-index:10000;
    min-width:260px; max-width:45vw; max-height:30vh; overflow:auto;
    border-radius:8px; border:1px solid #e0e0e0; background:#fafafa; color:#333;
    font:12px/1.35 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    box-shadow:0 2px 6px rgba(0,0,0,.15);
  }
  #logHeader { display:flex; align-items:center; justify-content:space-between; padding:6px 8px; background:#f0f0f3; border-bottom:1px solid #e0e0e0; }
  #logBody { padding:6px 8px; }
  #btnToggleLog { border:1px solid #ccc; border-radius:6px; background:#6a1b9a; padding:2px 6px; font-size:12px; cursor:pointer; }

  @media (max-width: 600px) {
    #panel { width:92vw; left:4vw; top:12px; }
    #panelBody { max-height:calc(70vh - 40px); }
    #legend { left:12px; bottom:12px; }
    #toast { right:12px; bottom:12px; max-width:75vw; }
    #log { right:12px; bottom:150px; max-width:75vw; }
    #insightsPanel { width:90vw; right:5vw; top:auto; bottom:160px; }
    #aiPanel { width:90vw; right:5vw; height:60vh; top:auto; bottom:250px; }
  }
</style>
</head>
<body>
<div id="map"></div>

<div id="panel">
<div id="panelHeader">
  <div class="title">
    <img src="madscience-logo.png" alt="Mad Science" style="height:28px; margin-right:8px;">
    <span>CRM Control Panel</span>
    <span class="badge">v15.0</span>
  </div>
  <button id="btnCollapsePanel" title="Collapse/Expand">Collapse</button>
</div>

  <div id="panelBody">
    <!-- Tabs for Filters and AI Tools only -->
    <div class="tabs">
      <div class="tab active" data-tab="filters">Filters</div>
      <div class="tab" data-tab="ai-tools">AI Tools</div>
    </div>

    <!-- Filters Tab (Enhanced CRM Content) -->
    <div id="filters-content" class="tab-content active">
      <div class="filter-block" style="margin-bottom:8px;">
        <label for="territorySel"><strong>Territory:</strong></label><br>
        <select id="territorySel">
          <option value="">-- Select a territory --</option>
        </select>
      </div>

      <div style="margin-bottom:8px;">
        <div style="font-weight:600; margin-bottom:4px;">Status Pipeline</div>
        <div class="status-filter-grid">
          <label class="status-filter-item"><input type="checkbox" class="statusChk" value="none"><span class="status-label">None</span></label>
          <label class="status-filter-item"><input type="checkbox" class="statusChk" value="firstoutreach"><span class="status-label">First Outreach</span></label>
          <label class="status-filter-item"><input type="checkbox" class="statusChk" value="replied"><span class="status-label">Customer Replied</span></label>
          <label class="status-filter-item"><input type="checkbox" class="statusChk" value="inprogress"><span class="status-label">In Progress</span></label>
          <label class="status-filter-item"><input type="checkbox" class="statusChk" value="current"><span class="status-label">Current</span></label>
          <label class="status-filter-item"><input type="checkbox" class="statusChk" value="uninterested"><span class="status-label">Uninterested</span></label>
        </div>
      </div>

      <div style="margin-bottom:8px;">
        <div style="font-weight:600; margin-bottom:4px;">Display Options</div>
        
        <label class="toggle-container">
          <input type="checkbox" id="showStaffToggle" checked>
          <span class="toggle-slider"></span>
          <span class="toggle-label">Show Staff</span>
        </label>
        
        <label class="toggle-container">
          <input type="checkbox" id="showStaleToggle">
          <span class="toggle-slider"></span>
          <span class="toggle-label">Highlight Stale Contacts</span>
        </label>
      </div>

      <div style="margin-bottom:8px;">
        <div style="font-weight:600; margin-bottom:4px;">Group</div>
        <select id="groupSel" multiple size="7" style="width:100%;"></select>
        <div class="row" style="margin-top:6px;">
          <button id="groupClear" type="button">Clear</button>
          <button id="groupSelectAll" type="button">Select all</button>
          <button id="btnToggleList" type="button">List View: OFF</button>
        </div>
      </div>

      <div style="margin-bottom:8px;">
        <div style="font-weight:600; margin-bottom:4px;">Search</div>
        <input id="searchBox" type="text" placeholder="Name, address, or notes..." style="width:100%; padding:6px;">
        <div class="row" style="margin-top:6px;">
          <button id="btnSearch" type="button">Apply</button>
          <button id="btnClearSearch" type="button">Clear</button>
          <button id="btnZoomFirst" type="button">Zoom to first</button>
        </div>
      </div>

      <div id="listContainer" style="display:none; margin:10px 0; border:1px solid #ddd; border-radius:8px; max-height:220px; overflow:auto;">
        <div style="padding:6px 8px; font-weight:600; border-bottom:1px solid #eee;">Locations</div>
        <div id="schoolList" style="max-height:180px; overflow:auto;"></div>
      </div>

      <hr style="margin:10px 0;">

      <div class="row" style="align-items:center; flex-wrap:wrap;">
        <button id="btnDownloadAll" type="button" style="font-weight:700;">Download CSV (All)</button>
        <button id="btnDownloadFiltered" type="button" style="font-weight:700;">Download Filtered CSV</button>
      </div>
    </div>

    <!-- AI Tools Tab -->
    <div id="ai-tools-content" class="tab-content">
      <div style="margin-bottom:12px;">
        <div style="font-weight:600; margin-bottom:6px;">‚öôÔ∏è API Configuration</div>
        
        <!-- Claude API Status & Config -->
        <div style="display: flex; align-items: center; margin-bottom: 4px;">
          <button onclick="configureClaudeAPI()" type="button" style="flex: 1; background: #9C27B0; color: white;">‚öôÔ∏è Configure Claude API</button>
          <div id="claude-status" class="api-status" style="margin-left: 8px; font-size: 12px;">‚ùå</div>
        </div>
        
        <!-- Gmail API Status & Config -->
        <div style="display: flex; align-items: center; margin-bottom: 4px;">
          <div style="display: flex; gap: 4px; flex: 1;">
            <button onclick="configureGmailCredentials()" type="button" style="flex: 1; background: #4285F4; color: white; font-size: 11px;">üìß Gmail Setup</button>
            <button onclick="authorizeGmail()" type="button" style="flex: 1; background: #34A853; color: white; font-size: 11px;">üîë Authorize</button>
          </div>
          <div id="gmail-status" class="api-status" style="margin-left: 8px; font-size: 12px;">‚ùå</div>
        </div>
        
        <!-- User Profile Status & Config -->
        <div style="display: flex; align-items: center; margin-bottom: 4px;">
          <button onclick="setUserProfile()" type="button" style="flex: 1; background: #607D8B; color: white;">üë§ Set User Profile</button>
          <div id="profile-status" class="api-status" style="margin-left: 8px; font-size: 12px;">‚ùå</div>
        </div>
        
        <div style="font-size:11px; color:#666; margin-top:4px;">Set up AI and email integration</div>
      </div>

      <div style="margin-bottom:12px;">
        <div style="font-weight:600; margin-bottom:6px;">ü§ñ AI Assistant</div>
        <button id="btnOpenAI" type="button" style="width:100%;">Open Chat Assistant</button>
        <div style="font-size:11px; color:#666; margin-top:4px;">Ask questions about your data in natural language</div>
      </div>

      <div style="margin-bottom:12px;">
        <div style="font-weight:600; margin-bottom:6px;">üîç Advanced Search</div>
        <input id="aiSearchBox" type="text" placeholder="Try: 'uncontacted', 'with notes', 'in progress'..." style="width:100%; padding:6px; margin-bottom:6px;">
        <button id="btnAISearch" type="button" style="width:100%;">Search with Keywords</button>
        <div style="font-size:11px; color:#666; margin-top:4px;">Searches status, notes, and all fields with smart matching</div>
      </div>

      <div style="margin-bottom:12px;">
        <div style="font-weight:600; margin-bottom:6px;">üìä Quick Analysis</div>
        <button id="btnAnalyzeTerritory" type="button" style="width:100%; margin-bottom:4px;">Analyze Current View</button>
        <button id="btnPredictGrowth" type="button" style="width:100%;">Predict Growth Potential</button>
      </div>

      <div style="margin-bottom:12px;">
        <div style="font-weight:600; margin-bottom:6px;">üìà Reports</div>
        <button id="btnGenerateReport" type="button" style="width:100%;">Generate Analysis Report</button>
        <div style="font-size:11px; color:#666; margin-top:4px;">Creates a downloadable report with insights</div>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Insights Panel -->
<div id="insightsPanel">
  <div id="insightsHeader">
    <div style="font-weight:700; font-size:14px;">üìä CRM Insights</div>
    <button id="btnCollapseInsights" title="Collapse/Expand">Collapse</button>
  </div>
  <div id="insightsBody">
    <div id="insights">
      <div class="insight-section">
        <h4>Overview</h4>
        <div class="muted">Select a territory or group to see insights</div>
      </div>
    </div>
  </div>
</div>

<!-- AI Assistant Panel -->
<div id="aiPanel">
  <div id="aiHeader">
    <strong>ü§ñ AI Assistant</strong>
    <button id="btnCloseAI" style="background:transparent; border:1px solid #fff; color:#fff;">‚úï</button>
  </div>
  <div id="aiChat"></div>
  <div id="aiInputArea">
    <input id="aiInput" type="text" placeholder="Ask about schools, territories, or strategies...">
    <button id="aiSend">Send</button>
  </div>
</div>

<!-- AI Toggle Button -->
<button id="btnToggleAI" title="Toggle AI Assistant">ü§ñ</button>

<div id="legend">
  <div style="font-weight:700; margin-bottom:6px;">Status Legend</div>
  <div><span class="swatch" style="background:#808080;"></span> None</div>
  <div><span class="swatch" style="background:#5DADE2;"></span> First Outreach</div>
  <div><span class="swatch" style="background:#17becf;"></span> Customer Replied</div>
  <div><span class="swatch" style="background:#ff7f0e;"></span> In Progress</div>
  <div><span class="swatch" style="background:#2ca02c;"></span> Current</div>
  <div><span class="swatch" style="background:#d62728;"></span> Uninterested</div>
  <div><span class="swatch" style="background:#800080;"></span> Staff</div>
</div>

<div id="toast"></div>

<div id="log">
  <div id="logHeader">
    <strong>Log</strong>
    <button id="btnToggleLog" aria-expanded="false">Expand</button>
  </div>
  <div id="logBody" style="display:none;"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ===== CONFIG ‚Äî SET THESE ===== */
const SHEETS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwLziNp4LZSh1CMl0KcbjCZDM5d1TlX8BaAqT8A2uBd5eiHUEwVmYFNDMhM6G51Ele-lQ/exec";  // GET CSV data
const WRITE_ENDPOINT  = "https://script.google.com/macros/s/AKfycbwLziNp4LZSh1CMl0KcbjCZDM5d1TlX8BaAqT8A2uBd5eiHUEwVmYFNDMhM6G51Ele-lQ/exec";  // POST updates
const WRITE_SECRET    = "123456pooydiapers";  // Authentication key
const SHEET_TAB_NAME  = "Sheet1";  // Google Sheets tab name
const TERRITORIES_URL = "territories.json";  // Territory boundaries file

// Enhanced CRM status colors
const COLOR = { 
  none:"#808080",           // Gray - untouched
  firstoutreach:"#5DADE2",  // Light Blue - we reached out  
  replied:"#17becf",        // Teal - customer replied
  inprogress:"#ff7f0e",     // Orange - actively negotiating
  current:"#2ca02c",        // Green - active customer
  uninterested:"#d62728",   // Red - dead lead
  staff:"#800080"           // Purple - internal
};

// Days since last contact color coding
function getStaleColor(daysSince) {
  if (daysSince === null) return '#808080'; // Never contacted
  if (daysSince <= 3) return '#2ca02c';     // Fresh - green
  if (daysSince <= 7) return '#ff7f0e';     // Warm - orange  
  if (daysSince <= 14) return '#d62728';    // Cold - red
  return '#8B0000';                         // Stale - dark red
}

/* ===== Map ===== */
const map = L.map('map').setView([45.2, -62.99], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

/* ===== Log/Toast ===== */
function log(msg){
  const el=document.getElementById('logBody');
  const t=new Date().toLocaleTimeString();
  el.insertAdjacentHTML('beforeend', `<div><b>${t}</b> ${msg}</div>`);
  el.scrollTop=el.scrollHeight;
}
function showToast(msg, kind='ok'){
  const t=document.getElementById('toast');
  if(kind==='error'){t.style.background='#fdecea';t.style.border='1px solid #f5c2c0';t.style.color='#b71c1c';}
  else {t.style.background='#e8f5e9';t.style.border='1px solid #c8e6c9';t.style.color='#2e7d32';}
  t.textContent=msg; t.style.display='block'; clearTimeout(t._hideTimer);
  t._hideTimer=setTimeout(()=>{t.style.display='none';},3200);
}

/* Log minimize */
document.getElementById('btnToggleLog').addEventListener('click',()=>{
  const btn = document.getElementById('btnToggleLog');
  const body= document.getElementById('logBody');
  const isOpen = btn.getAttribute('aria-expanded') === 'true';
  if(isOpen){ body.style.display='none'; btn.textContent='Expand'; btn.setAttribute('aria-expanded','false'); }
  else { body.style.display='block'; btn.textContent='Minimize'; btn.setAttribute('aria-expanded','true'); }
});

/* Panel collapse (session-persisted) */
(function setupPanelCollapse(){
  const panel = document.getElementById('panel');
  const btn = document.getElementById('btnCollapsePanel');
  const KEY = 'panelCollapsed';
  function apply(state){ panel.classList.toggle('is-collapsed', !!state); btn.textContent = state ? 'Expand' : 'Collapse'; btn.setAttribute('aria-expanded', String(!state)); }
  const saved = sessionStorage.getItem(KEY) === '1';
  apply(saved);
  btn.addEventListener('click',()=>{
    const newState = !panel.classList.contains('is-collapsed');
    sessionStorage.setItem(KEY, newState ? '1' : '0');
    apply(newState);
  });
})();

/* Safety */
window.addEventListener('error', (e)=>{ log('Error: '+ (e && e.message ? e.message : e)); showToast('JS error: '+(e && e.message ? e.message : 'unknown'), 'error'); });
window.addEventListener('unhandledrejection', (e)=>{ log('Promise rejection: '+ (e && e.reason ? e.reason : e)); showToast('Unhandled rejection', 'error'); });

/* Utilities */
async function fetchWithTimeout(url, options={}, ms=15000){
  const ctrl = new AbortController();
  const id = setTimeout(()=>ctrl.abort(), ms);
  try{ return await fetch(url, { ...options, signal: ctrl.signal }); }
  finally{ clearTimeout(id); }
}

/* CSV */
function splitCSVLine(line){const out=[];let cur='',q=false;for(let i=0;i<line.length;i++){const c=line[i];if(c==='"'){if(q&&line[i+1]==='"'){cur+='"';i++}else q=!q}else if(c===','&&!q){out.push(cur);cur=''}else cur+=c}out.push(cur);return out}
function parseCSV(text){const clean=text.replace(/^\uFEFF/,'').replace(/\r\n/g,'\n');const lines=clean.split('\n').filter(l=>l.trim());if(!lines.length)return{header:[],rows:[]};const header=splitCSVLine(lines[0]).map(h=>h.trim());const rows=lines.slice(1).map(line=>{const cols=splitCSVLine(line);const rec={};header.forEach((h,i)=>rec[h]=(cols[i]??'').trim());return rec});return{header,rows}}

/* Geometry */
function bboxOfRing(r){let w=Infinity,s=Infinity,e=-Infinity,n=-Infinity;for(const[lon,lat]of r){if(lon<w)w=lon;if(lon>e)e=lon;if(lat<s)s=lat;if(lat>n)n=lat}return[w,s,e,n]}
function expandBBox(b,a){if(!b)return a.slice();if(a[0]<b[0])b[0]=a[0];if(a[1]<b[1])b[1]=a[1];if(a[2]>b[2])b[2]=a[2];if(a[3]>b[3])b[3]=a[3];return b}
function bboxOfPolygon(p){return bboxOfRing(p[0])}
function bboxOfGeometry(g){if(!g)return null;if(g.type==='Polygon')return bboxOfPolygon(g.coordinates);if(g.type==='MultiPolygon'){let b=null;for(const p of g.coordinates)b=expandBBox(b,bboxOfPolygon(p));return b}return null}
function pointInRing(x,y,ring){let inside=false;for(let i=0,j=ring.length-1;i<ring.length;j=i++){const[xi,yi]=ring[i],[xj,yj]=ring[j];const inter=((yi>y)!=(yj>y))&&(x<(xj-xi)*(y-yi)/((yj-yi)||1e-12)+xi);if(inter)inside=!inside}return inside}
function pointInGeometry(x,y,g){if(!g)return false;if(g.type==='Polygon'){const r=g.coordinates;if(!pointInRing(x,y,r[0]))return false;for(let i=1;i<r.length;i++)if(pointInRing(x,y,r[i]))return false;return true}if(g.type==='MultiPolygon'){for(const p of g.coordinates){const r=p;if(!pointInRing(x,y,r[0]))continue;let ok=true;for(let i=1;i<r.length;i++)if(pointInRing(x,y,r[i])){ok=false;break}if(ok)return true}}return false}

/* State */
let DATA=[], HEADER=[], markers=[], LIST_ON=false;
let GROUPS=[], TERRITORIES=[], currentTerritory=null, territoryLayer=null;

/* Normalize */
function normalizeRecords(rows){
  const latKeys=['lat','Lat','LAT','latitude','Latitude','LATITUDE','y','Y'];
  const lonKeys=['lon','Lon','LON','lng','Lng','LNG','long','Long','LONG','longitude','Longitude','LONGITUDE','x','X'];
  rows.forEach(r=>{
    let lat=null,lon=null;
    for(const k of latKeys) if(r[k]&&lat===null){const v=parseFloat(r[k]); if(Number.isFinite(v)) lat=v}
    for(const k of lonKeys) if(r[k]&&lon===null){const v=parseFloat(r[k]); if(Number.isFinite(v)) lon=v}
    if(Number.isFinite(lat)) r.lat=lat;
    if(Number.isFinite(lon)) r.lon=lon;
    const raw=(r.active??r.Active??r.ACTIVE??'').toString().trim().toUpperCase();
    r.active = raw==='' ? true : !(raw==='FALSE'||raw==='0'||raw==='NO'||raw==='N');
    if(r.Id && !Number.isFinite(r.Id)){const n=parseFloat(r.Id); if(Number.isFinite(n)) r.Id=n}
    // Initialize new CRM fields if they don't exist
    if(r.Notes === undefined && r.notes === undefined) r.Notes = '';
    if(r.ContactName === undefined && r.contactName === undefined) r.ContactName = '';
    if(r.ContactEmail === undefined && r.contactEmail === undefined) r.ContactEmail = '';
    if(r.LastModified === undefined && r.lastModified === undefined) r.LastModified = '';
  });
}
function isValidLatLon(lat,lon){return Number.isFinite(lat)&&Number.isFinite(lon)&&lat>=-90&&lat<=90&&lon>=-180&&lon<=180}

// Enhanced status normalization for CRM
function normalizeStatus(s){
  s=(s||'').toLowerCase().trim().replace(/[\s_-]+/g,''); 
  if(!['none','firstoutreach','replied','inprogress','current','uninterested','staff'].includes(s)) {
    // Handle legacy statuses
    if(s === 'recent') return 'firstoutreach';
    return 'none';
  } 
  return s;
}

// Calculate days since last contact
function daysSinceLastContact(record) {
  const lastMod = record.LastModified || record.lastModified || record['Last Modified'];
  if (!lastMod) return null;
  
  const lastDate = new Date(lastMod);
  const today = new Date();
  const diffTime = Math.abs(today - lastDate);
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  return diffDays;
}

function getStatusColor(r){return COLOR[normalizeStatus(r.Status||r.status)]||COLOR.none}

/* Territories */
async function loadTerritories(){
  const res = await fetch(TERRITORIES_URL, {cache:'no-store'});
  if(!res.ok) throw new Error('Territories HTTP '+res.status);
  const list = await res.json();
  TERRITORIES = Array.isArray(list)? list : [];
  TERRITORIES.forEach(t=>{ if(!t.id){t.id=(t.name||'territory').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'')} if(!t.bbox) t.bbox=bboxOfGeometry(t.geometry) });
  const sel=document.getElementById('territorySel');
  while(sel.options.length>1) sel.remove(1);
  TERRITORIES.forEach(t=>{const opt=document.createElement('option'); opt.value=t.id; opt.textContent=t.name||t.id; sel.appendChild(opt)});
}
function onTerritoryChange(){
  const id=document.getElementById('territorySel').value;
  currentTerritory = id ? TERRITORIES.find(t=>t.id===id) : null;
  if(territoryLayer){map.removeLayer(territoryLayer); territoryLayer=null}
  if(currentTerritory){
    territoryLayer=L.geoJSON(currentTerritory.geometry,{style:{color:currentTerritory.color||'#555',weight:1,opacity:0.8,dashArray:'4,6',fillColor:currentTerritory.color||'#555',fillOpacity:0.08},interactive:false,className:'territory-boundary'}).addTo(map);
    const b=currentTerritory.bbox; if(b){const[w,s,e,n]=b; map.fitBounds([[s,w],[n,e]])}
  }
  // Rebuild group list for new territory
  buildGroupList();
  requestAnimationFrame(() => {
    applyFilters();
    // Force insights update
    setTimeout(updateInsights, 100);
  });
}

/* Enhanced Filtering with CRM Status Support */
let baseVisiblePredicate = rec => true;
function updateFilter(){
  const statusSet=new Set(Array.from(document.querySelectorAll('.statusChk')).filter(cb=>cb.checked).map(cb=>cb.value));
  const showStaff = document.getElementById('showStaffToggle').checked;
  const groupSel=document.getElementById('groupSel');
  const groupSet=new Set(Array.from(groupSel.selectedOptions).map(o=>o.value));
  const q=(document.getElementById('searchBox').value||'').trim().toLowerCase();
  
  baseVisiblePredicate=function(rec){
    if(rec.active===false) return false;
    
    const st = normalizeStatus(rec.Status||rec.status);
    
    // Handle staff separately from business statuses
    if(st === 'staff') return showStaff;
    
    // Check business statuses
    if(statusSet.size && !statusSet.has(st)) return false;
    if(groupSet.size){const g=(rec.Group||rec.group||'').trim(); if(!groupSet.has(g)) return false;}
    if(q){const hay=((rec.School||rec.SchoolName||rec.Name||'')+' '+(rec.Address||'')+' '+(rec.Group||'')+' '+(rec.Notes||'')).toLowerCase(); if(!hay.includes(q)) return false;}
    return true;
  };
  
  log(`Status filter changed: ${Array.from(statusSet).join(', ')}`);
  
  requestAnimationFrame(()=>{ 
    applyFilters(); 
    if(LIST_ON) updateList(); 
    // Update insights immediately after filters change
    updateInsights();
  });
}

function territoryVisible(rec){
  if(!currentTerritory) return false;            // show nothing until a territory is selected
  if(!baseVisiblePredicate(rec)) return false;
  if(!Number.isFinite(rec.lat)||!Number.isFinite(rec.lon)) return false;
  if(rec.TerritoryId) return rec.TerritoryId===currentTerritory.id;
  const geo=currentTerritory.geometry, b=currentTerritory.bbox||bboxOfGeometry(geo);
  if(b){const[w,s,e,n]=b; if(rec.lon<w||rec.lon>e||rec.lat<s||rec.lat>n) return false;}
  return pointInGeometry(rec.lon,rec.lat,geo);
}
let visiblePredicate = territoryVisible;
function applyFilters(){
  const showStale = document.getElementById('showStaleToggle').checked;
  
  for (let i=0; i<markers.length; i++){
    const m = markers[i];
    if (!m || !m._rec) continue; // Safety check
    
    const show = visiblePredicate(m._rec);
    if(show){
      if(!map.hasLayer(m)) m.addTo(map);
      const col=getStatusColor(m._rec);
      
      // Apply stale highlighting
      let markerOptions = {color:col, fillColor:col};
      
      if (showStale && normalizeStatus(m._rec.Status || m._rec.status) !== 'staff') {
        const daysSince = daysSinceLastContact(m._rec);
        if (daysSince !== null && daysSince > 7) {
          // Add visual indicators for stale contacts
          markerOptions.color = '#ff0000';
          markerOptions.weight = 3;
          // Add pulsing effect for very stale contacts
          if (daysSince > 14) {
            markerOptions.radius = 8;
          }
        }
      }
      
      m.setStyle(markerOptions);
    } else {
      if(map.hasLayer(m)) map.removeLayer(m);
    }
  }
}

/* Enhanced Popups with CRM Fields */
function formatPhone(p){const raw=String(p||'').trim(); if(!raw) return ''; const digits=raw.replace(/[^\d+]/g,''); return `<a href="tel:${digits}">${raw}</a>`}
function formatEmail(e){const raw=String(e||'').trim(); if(!raw) return ''; return `<a href="mailto:${raw}">${raw}</a>`}
function escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML;}

function buildPopupHTML(rec){
  const name=rec.School||rec.SchoolName||rec.Name||rec.LocationName||rec.Location||'Location';
  const addr=rec.Address||rec.address||'';
  const phone=rec.Phone||rec.phone||rec.Telephone||rec['Phone Number']||rec['Contact Phone']||'';
  const email=rec.Email||rec.email||rec['Email Address']||rec['Contact Email']||'';
  const group=(rec.Group||rec.group||'').trim();
  const notes=(rec.Notes||rec.notes||'').trim();
  const st=normalizeStatus(rec.Status||rec.status);
  
  // New CRM fields
  const contactName = rec.ContactName || rec.contactName || rec['Contact Name'] || '';
  const contactEmail = rec.ContactEmail || rec.Email || rec.email || rec['Email Address'] || '';
  const lastModified = rec.LastModified || rec.lastModified || rec['Last Modified'] || '';
  
  // Calculate days since last contact
  const daysSince = daysSinceLastContact(rec);
  const daysDisplay = daysSince !== null ? 
    `<span style="color:${getStaleColor(daysSince)}; font-weight: bold;">${daysSince} days ago</span>` : 
    '<span style="color:#999;">Never contacted</span>';
  
  const statusSelect = `
    <select data-role="status-select" style="width:100%; margin: 5px 0;">
      <option value="none"${st==='none'?' selected':''}>None</option>
      <option value="firstoutreach"${st==='firstoutreach'?' selected':''}>First Outreach</option>
      <option value="replied"${st==='replied'?' selected':''}>Customer Replied</option>
      <option value="inprogress"${st==='inprogress'?' selected':''}>In Progress</option>
      <option value="current"${st==='current'?' selected':''}>Current</option>
      <option value="uninterested"${st==='uninterested'?' selected':''}>Uninterested</option>
      ${st==='staff' ? '<option value="staff" selected>Staff</option>' : ''}
    </select>`;
  
  const canUpdateKey = !!(rec.Id || ((rec.School||rec.SchoolName||rec.Name||rec.LocationName||rec.Location) && rec.Address));
  const isStaff = st === 'staff';
  
  return `
    <div class="popup-header ${isStaff ? 'staff-header' : ''}">
      <h3>${escapeHtml(name)}</h3>
      ${group ? `<span class="group-badge">${escapeHtml(group)}</span>` : ''}
    </div>
    
    <div class="popup-content">
      <div class="popup-section">
        <strong>üìç Address:</strong> ${escapeHtml(addr)}
        ${phone ? `<br><strong>üìû Phone:</strong> ${formatPhone(phone)}` : ''}
        ${email ? `<br><strong>üìß Email:</strong> ${formatEmail(email)}` : ''}
      </div>
      
      <div class="popup-section">
        <strong>üìä Status:</strong> ${statusSelect}
      </div>
      
      <div class="popup-section">
        <strong>üë§ Contact Name:</strong>
        <input type="text" data-role="contact-name" value="${escapeHtml(contactName)}" 
               placeholder="Contact person name" style="width:100%; margin-top: 5px;" ${!canUpdateKey ? 'disabled' : ''}>
      </div>
      
      <div class="popup-section">
        <strong>üìß Contact Email:</strong>
        <input type="email" data-role="contact-email" value="${escapeHtml(contactEmail)}" 
               placeholder="contact@school.com" style="width:100%; margin-top: 5px;" ${!canUpdateKey ? 'disabled' : ''}>
      </div>
      
      <div class="popup-section">
        <strong>üìù Notes:</strong>
        <textarea data-role="notes-input" placeholder="e.g., 'Devan contacted Aug 22 by email'" 
                  style="width:100%; height: 80px; margin-top: 5px; resize: vertical;" ${!canUpdateKey ? 'disabled' : ''}>${escapeHtml(notes)}</textarea>
        <button data-role="add-timestamp" style="font-size:11px; padding:2px 6px; border-radius:4px; margin-top: 4px;" type="button">+ Add Today</button>
      </div>
      
      <div class="popup-section">
        <strong>‚è∞ Last Contact:</strong> ${daysDisplay}
        ${lastModified ? `<br><small style="color:#666;">Modified: ${new Date(lastModified).toLocaleDateString()}</small>` : ''}
      </div>
      
      ${canUpdateKey ? `
        <div class="popup-actions">
          <button class="update-btn" data-role="update-record">üíæ Save Changes</button>
          ${gmailIntegration.getEmailButton(rec)}
        </div>
        
        ${gmailIntegration.getLastEmailInfo(rec)}
      ` : `
        <div class="popup-readonly">
          <small>üîí Read-only mode - Add update key to edit</small>
        </div>
      `}
    </div>`;
}

function addCircleFor(rec){
  const m=L.circleMarker([rec.lat,rec.lon],{radius:6,color:getStatusColor(rec),fillColor:getStatusColor(rec),fillOpacity:0.9,weight:1});
  m._rec=rec;
  m.on('click',()=>{
    const html = buildPopupHTML(rec);
    m.bindPopup(html, {maxWidth: 400}).openPopup();
    
    // Enhanced popup interaction setup
    setTimeout(()=>{
      const container = document.querySelector('.leaflet-popup-content');
      if (!container) return;
      
      const sel = container.querySelector('[data-role="status-select"]');
      const contactNameInput = container.querySelector('[data-role="contact-name"]');
      const contactEmailInput = container.querySelector('[data-role="contact-email"]');
      const notesInput = container.querySelector('[data-role="notes-input"]');
      const updateBtn = container.querySelector('[data-role="update-record"]');
      const timestampBtn = container.querySelector('[data-role="add-timestamp"]');
      
      if (!sel || !updateBtn) return;
      
      // Track unsaved changes
      let hasUnsavedChanges = false;
      const checkForChanges = () => {
        const currentSt = sel.value;
        const currentContactName = contactNameInput ? contactNameInput.value.trim() : '';
        const currentContactEmail = contactEmailInput ? contactEmailInput.value.trim() : '';
        const currentNotes = notesInput ? notesInput.value.trim() : '';
        const originalSt = normalizeStatus(rec.Status||rec.status);
        const originalContactName = (rec.ContactName||rec.contactName||'').trim();
        const originalContactEmail = (rec.ContactEmail||rec.Email||rec.email||'').trim();
        const originalNotes = (rec.Notes||rec.notes||'').trim();
        
        hasUnsavedChanges = (currentSt !== originalSt || 
                            currentContactName !== originalContactName ||
                            currentContactEmail !== originalContactEmail ||
                            currentNotes !== originalNotes);
        
        if (hasUnsavedChanges) {
          updateBtn.style.background = '#ff7f0e';
          updateBtn.textContent = 'üíæ Save Changes*';
        } else {
          updateBtn.style.background = '#2ca02c';
          updateBtn.textContent = 'üíæ Save Changes';
        }
      };
      
      // Monitor changes
      sel.addEventListener('change', checkForChanges);
      if (contactNameInput) contactNameInput.addEventListener('input', checkForChanges);
      if (contactEmailInput) contactEmailInput.addEventListener('input', checkForChanges);
      if (notesInput) notesInput.addEventListener('input', checkForChanges);
      
      // Add timestamp button handler
      if (timestampBtn && notesInput) {
        timestampBtn.addEventListener('click', () => {
          const today = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          const currentText = notesInput.value;
          const newText = currentText ? `${currentText}\n${today}: ` : `${today}: `;
          notesInput.value = newText;
          notesInput.focus();
          notesInput.setSelectionRange(newText.length, newText.length);
          checkForChanges();
        });
      }
      
      // Save function
      const saveChanges = async () => {
        const newSt = sel.value;
        const newContactName = contactNameInput ? contactNameInput.value.trim() : '';
        const newContactEmail = contactEmailInput ? contactEmailInput.value.trim() : '';
        const newNotes = notesInput ? notesInput.value.trim() : '';
        const oldSt = normalizeStatus(rec.Status||rec.status);
        const oldContactName = (rec.ContactName||rec.contactName||'').trim();
        const oldContactEmail = (rec.ContactEmail||rec.Email||rec.email||'').trim();
        const oldNotes = (rec.Notes||rec.notes||'').trim();
        
        // Check if anything changed
        if (newSt === oldSt && newContactName === oldContactName && 
            newContactEmail === oldContactEmail && newNotes === oldNotes) {
          showToast('No changes to save');
          return;
        }
        
        // Show saving state
        updateBtn.disabled = true;
        updateBtn.textContent = 'üíæ Saving...';
        
        // Update local record optimistically
        const oldLastModified = rec.LastModified;
        rec.Status = newSt;
        rec.ContactName = newContactName;
        rec.ContactEmail = newContactEmail;
        rec.Notes = newNotes;
        rec.LastModified = new Date().toISOString();
        
        m.setStyle({ color: getStatusColor(rec), fillColor: getStatusColor(rec) });
        
        const keyField = rec.Id ? 'Id' : 'School+Address';
        const keyValue = rec.Id ? String(rec.Id) : JSON.stringify({ 
          School: (rec.School||rec.SchoolName||rec.Name||rec.LocationName||rec.Location||''), 
          Address: (rec.Address||'') 
        });
        
        // Build patch with only changed fields
        const patch = { LastModified: rec.LastModified };
        if (newSt !== oldSt) patch.Status = newSt;
        if (newContactName !== oldContactName) patch.ContactName = newContactName;
        if (newContactEmail !== oldContactEmail) patch.ContactEmail = newContactEmail;
        if (newNotes !== oldNotes) patch.Notes = newNotes;
        
        try{
          const res = await updateRowInSheet({ keyField, keyValue, patch });
          log('saved CRM changes to row '+(res && res.rowNumber ? res.rowNumber : '?'));
          
          // Show what was updated
          const updates = [];
          if (newSt !== oldSt) updates.push('status');
          if (newContactName !== oldContactName) updates.push('contact name');
          if (newContactEmail !== oldContactEmail) updates.push('contact email');
          if (newNotes !== oldNotes) updates.push('notes');
          showToast(`‚úÖ Updated ${updates.join(', ')}`);
          
          // Refresh popup with new data
          m.setPopupContent(buildPopupHTML(rec));
          
          // Update insights if filters might be affected
          requestAnimationFrame(() => {
            applyFilters();
            updateInsights();
          });
        }catch(err){
          log('CRM update FAIL: '+(err && err.message ? err.message : err));
          showToast('‚ùå Could not save changes, reverting','error');
          // Revert changes
          rec.Status = oldSt;
          rec.ContactName = oldContactName;
          rec.ContactEmail = oldContactEmail;
          rec.Notes = oldNotes;
          rec.LastModified = oldLastModified;
          m.setStyle({ color: getStatusColor(rec), fillColor: getStatusColor(rec) });
          m.setPopupContent(buildPopupHTML(rec));
        }
      };
      
      // Button click handlers
      updateBtn.addEventListener('click', saveChanges);
      
      
      // Ctrl+Enter in notes field
      if (notesInput) {
        notesInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            saveChanges();
          }
        });
      }
    },0);
  });
  markers.push(m);
  return m;
}

/* Groups/List - Territory-Aware */
function buildGroupList(){
  const sel=document.getElementById('groupSel'); 
  
  // If no territory selected, show all groups
  if (!currentTerritory) {
    const set=new Set();
    DATA.forEach(r=>{const g=(r.Group||r.group||'').trim(); if(g) set.add(g)});
    GROUPS=Array.from(set).sort();
    sel.innerHTML=''; 
    GROUPS.forEach(g=>{const o=document.createElement('option'); o.value=g; o.textContent=g; sel.appendChild(o)});
    return;
  }
  
  // Filter groups based on current territory
  const set=new Set();
  DATA.forEach(r=>{
    // Check if school is in current territory
    if (!isValidLatLon(r.lat,r.lon)) return;
    
    // Use TerritoryId if available, otherwise check geometry
    let inTerritory = false;
    if (r.TerritoryId || r.territoryId || r.territory_id) {
      inTerritory = (r.TerritoryId || r.territoryId || r.territory_id) === currentTerritory.id;
    } else {
      inTerritory = pointInGeometry(r.lon, r.lat, currentTerritory.geometry);
    }
    
    if (inTerritory) {
      const g=(r.Group||r.group||'').trim(); 
      if(g) set.add(g);
    }
  });
  
  GROUPS=Array.from(set).sort();
  sel.innerHTML=''; 
  
  if (GROUPS.length === 0) {
    const o=document.createElement('option'); 
    o.value=''; 
    o.textContent='-- No groups in this territory --';
    o.disabled = true;
    sel.appendChild(o);
  } else {
    GROUPS.forEach(g=>{
      const o=document.createElement('option'); 
      o.value=g; 
      o.textContent=g; 
      sel.appendChild(o);
    });
  }
  
  // Clear any selected groups that don't exist in new territory
  for(const o of sel.options) {
    if(o.selected && !GROUPS.includes(o.value)) {
      o.selected = false;
    }
  }
}
function updateList(){
  const list=document.getElementById('schoolList'); list.innerHTML='';
  const items=[];
  markers.forEach(m=>{
    if (!m || !m._rec) return;
    const r=m._rec; 
    const st = normalizeStatus(r.Status || r.status);
    // Only show in list if visible using map.hasLayer
    if(map.hasLayer(m)) {
      items.push({
        name:r.School||r.SchoolName||r.Name||r.LocationName||r.Location||'Location',
        addr:r.Address||'',
        lat:r.lat,
        lon:r.lon,
        m
      });
    }
  });
  items.sort((a,b)=>a.name.localeCompare(b.name));
  items.forEach(it=>{
    const d=document.createElement('div'); 
    d.className='list-item'; 
    d.innerHTML=`<strong>${it.name}</strong><br><span class="muted">${it.addr}</span>`; 
    d.addEventListener('click',()=>{map.setView([it.lat,it.lon],14); it.m.fire('click')}); 
    list.appendChild(d);
  });
}

/* Enhanced Insights with CRM Tracking */
function updateInsights(){
  if(!markers.length) return;
  
  // Get visible markers by checking if they're currently on the map
  const visibleMarkers = markers.filter(m => m && m._rec && map.hasLayer(m));
  const businessMarkers = visibleMarkers.filter(m => normalizeStatus(m._rec.Status || m._rec.status) !== 'staff');
  const staffMarkers = visibleMarkers.filter(m => normalizeStatus(m._rec.Status || m._rec.status) === 'staff');
  
  // Status breakdown (excluding staff)
  const statusCounts = {};
  const staleContacts = [];
  const followUpNeeded = [];
  
  businessMarkers.forEach(m => {
    const rec = m._rec;
    const status = normalizeStatus(rec.Status || rec.status);
    statusCounts[status] = (statusCounts[status] || 0) + 1;
    
    // Check for stale contacts and follow-up needs
    const daysSince = daysSinceLastContact(rec);
    const schoolName = rec.School || rec.SchoolName || rec.Name || 'School';
    
    if (daysSince !== null) {
      // Follow-up logic based on status
      let followUpDays = 0;
      switch(status) {
        case 'firstoutreach': followUpDays = 3; break;
        case 'replied': followUpDays = 7; break;
        case 'inprogress': followUpDays = 5; break;
        case 'current': followUpDays = 30; break;
        default: followUpDays = 14; break;
      }
      
      if (daysSince >= followUpDays) {
        followUpNeeded.push({
          school: schoolName,
          status: status,
          days: daysSince,
          urgency: daysSince > followUpDays * 2 ? 'high' : 'medium'
        });
      }
      
      if (daysSince > 14) {
        staleContacts.push({
          school: schoolName,
          days: daysSince
        });
      }
    }
  });
  
  // Build context
  const groupSel = document.getElementById('groupSel');
  const selectedGroups = Array.from(groupSel.selectedOptions).map(o => o.value);
  let context = '';
  if (selectedGroups.length > 0) {
    context = ` for ${selectedGroups.join(', ')}`;
  }
  if (currentTerritory) {
    context += ` in ${currentTerritory.name}`;
  }
  
  // Calculate metrics
  const totalBusiness = businessMarkers.length;
  const totalStaff = staffMarkers.length;
  const noneCount = statusCounts.none || 0;
  const coverage = totalBusiness > 0 ? Math.round((totalBusiness - noneCount) / totalBusiness * 100) : 0;
  const conversionRate = businessMarkers.length > 0 ? Math.round((statusCounts.current || 0) / businessMarkers.length * 100) : 0;
  
  // Build insights HTML
  let insightsHTML = `
    <div class="insight-section">
      <h4>üìä Overview${context}</h4>
      <div class="metrics-grid">
        <div class="metric">
          <div class="metric-value">${totalBusiness}</div>
          <div class="metric-label">Schools</div>
        </div>
        <div class="metric">
          <div class="metric-value">${coverage}%</div>
          <div class="metric-label">Coverage</div>
        </div>
        <div class="metric">
          <div class="metric-value">${conversionRate}%</div>
          <div class="metric-label">Conversion</div>
        </div>
        ${totalStaff > 0 ? `
        <div class="metric staff-metric">
          <div class="metric-value">${totalStaff}</div>
          <div class="metric-label">Staff</div>
        </div>` : ''}
      </div>
    </div>`;
  
  // Status breakdown
  if (totalBusiness > 0) {
    insightsHTML += `
      <div class="insight-section">
        <h4>üéØ Pipeline Status</h4>
        <div class="status-breakdown">`;
        
    ['none', 'firstoutreach', 'replied', 'inprogress', 'current', 'uninterested'].forEach(status => {
      const count = statusCounts[status] || 0;
      if (count > 0) {
        const percentage = Math.round(count / totalBusiness * 100);
        const statusNames = {
          none: 'None',
          firstoutreach: 'First Outreach',
          replied: 'Customer Replied', 
          inprogress: 'In Progress',
          current: 'Current',
          uninterested: 'Uninterested'
        };
        insightsHTML += `
          <div class="status-item" style="border-left: 4px solid ${COLOR[status]};">
            <strong>${statusNames[status]}</strong>: ${count} (${percentage}%)
          </div>`;
      }
    });
    
    insightsHTML += `</div></div>`;
  }
  
  // Follow-up alerts
  if (followUpNeeded.length > 0) {
    insightsHTML += `
      <div class="insight-section alert-section">
        <h4>‚ö†Ô∏è Follow-up Required (${followUpNeeded.length})</h4>
        <div class="follow-up-list">`;
        
    followUpNeeded.slice(0, 5).forEach(item => {
      const urgencyColor = item.urgency === 'high' ? '#d62728' : '#ff7f0e';
      const statusNames = {
        none: 'no contact',
        firstoutreach: 'first outreach',
        replied: 'customer reply', 
        inprogress: 'in progress',
        current: 'current client check'
      };
      insightsHTML += `
        <div class="follow-up-item" style="border-left: 3px solid ${urgencyColor};">
          <strong>${item.school}</strong><br>
          <small>${item.days} days since ${statusNames[item.status] || item.status}</small>
        </div>`;
    });
    
    if (followUpNeeded.length > 5) {
      insightsHTML += `<div class="more-items">...and ${followUpNeeded.length - 5} more</div>`;
    }
    
    insightsHTML += `</div></div>`;
  }
  
  // Quick actions
  insightsHTML += `
    <div class="insight-section">
      <h4>üöÄ Quick Actions</h4>
      <div class="quick-actions">
        <button class="quick-btn" onclick="filterByStatus('none')">Focus Uncontacted (${noneCount})</button>
        <button class="quick-btn" onclick="filterByStale()">Show Stale Contacts (${staleContacts.length})</button>
      </div>
    </div>`;
  
  document.getElementById('insights').innerHTML = insightsHTML;
  
  // Highlight insights when context changes
  const insightsPanel = document.getElementById('insightsPanel');
  const insightsHeader = document.getElementById('insightsHeader');
  if (selectedGroups.length > 0 || currentTerritory) {
    insightsPanel.classList.add('highlighted');
    insightsHeader.classList.add('has-update');
    setTimeout(() => {
      insightsPanel.classList.remove('highlighted');
      insightsHeader.classList.remove('has-update');
    }, 1500);
  }
}

// Quick filter functions
function filterByStatus(status) {
  const checkboxes = document.querySelectorAll('.statusChk');
  // Clear existing selections
  checkboxes.forEach(cb => cb.checked = false);
  // Select the target status
  checkboxes.forEach(cb => {
    if (cb.value === status) cb.checked = true;
  });
  updateFilter();
}

function filterByStale() {
  document.getElementById('showStaleToggle').checked = true;
  updateFilter();
}

/* Downloads */
function toCSV(rows, header){
  const esc=v=>'"'+String(v==null?'':v).replace(/"/g,'""')+'"';
  // Ensure new CRM columns are included
  const crmColumns = ['ContactName', 'ContactEmail', 'LastModified'];
  const hasNotes = rows.some(r => r.Notes !== undefined || r.notes !== undefined);
  const finalHeader = [...header];
  
  // Add missing CRM columns
  crmColumns.forEach(col => {
    if (!header.includes(col) && rows.some(r => r[col] !== undefined)) {
      finalHeader.push(col);
    }
  });
  
  if (hasNotes && !header.includes('Notes') && !header.includes('notes')) {
    finalHeader.push('Notes');
  }
  
  const lines=[finalHeader.map(esc).join(',')];
  rows.forEach(r=>lines.push(finalHeader.map(h=>esc(r[h])).join(',')));
  return lines.join('\n');
}
function download(filename, text){
  const blob = new Blob([text], { type: 'text/csv;charset=utf-8' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  requestAnimationFrame(()=>{
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
}

/* Server call: update CRM fields */
async function updateRowInSheet({ keyField, keyValue, patch }){
  const res = await fetchWithTimeout(WRITE_ENDPOINT, {
    method: 'POST',
    headers: { 'Content-Type':'text/plain;charset=utf-8' },
    body: JSON.stringify({ secret: WRITE_SECRET, mode:'update', sheetName: SHEET_TAB_NAME, keyField, keyValue, patch }),
    cache: 'no-store', redirect: 'follow'
  }, 15000);
  const text = await res.text();
  let json={}; try{ json=JSON.parse(text);}catch(e){ log('update non-JSON body: '+text.slice(0,200)); }
  if (!res.ok || !json.ok){
    log(`update FAIL http=${res.status} body=${text.slice(0,240)}`);
    throw new Error((json && json.error) || ('HTTP '+res.status));
  }
  return json;
}

/* ===== ENHANCED AI FEATURES ===== */

// Enhanced AI Assistant with CRM Context
class EnhancedAIAssistant {
  constructor() {
    this.context = {
      lastQuery: '',
      history: [],
      apiKey: localStorage.getItem('ai_api_key') || '',
      totalSchools: 0,
      territories: [],
      currentTerritory: null,
      statusDistribution: {},
      crmMetrics: {}
    };
    this.patterns = {
      conversionRates: new Map(),
      bestTimes: [],
      successFactors: []
    };
    this.customPrompts = {
      emailGeneration: localStorage.getItem('ai_email_prompt') || this.getDefaultEmailPrompt(),
      systemInstructions: localStorage.getItem('ai_system_prompt') || this.getDefaultSystemPrompt()
    };
  }

  getDefaultEmailPrompt() {
    return `Generate a professional email for a Mad Science franchise to a school with this context:

School: {schoolName}
Contact: {contactName}
Current Status: {status}
Days Since Contact: {daysSince}
Recent Notes: {notes}
Territory: {territory}
Group: {group}

Requirements:
1. Match the tone to the status (introduction for new, follow-up for existing)
2. Be warm but professional
3. Include a clear call-to-action
4. Keep it under 150 words
5. Reference any relevant details from notes
6. If status is "replied", acknowledge their response
7. If stale (>7 days), acknowledge the time gap appropriately
8. Use proper contact name (not "there")
9. Avoid placeholder text like [Your Name]

Generate ONLY the email body (no subject line needed).`;
  }

  getDefaultSystemPrompt() {
    return `You are Claude, an AI assistant helping manage a Mad Science franchise CRM. You specialize in writing professional, personalized outreach emails to schools.

Key guidelines:
- Always use the actual contact name provided
- Reference specific details from notes when available
- Match tone to relationship status (new vs existing contact)
- Keep emails concise but personal
- Include clear next steps or call-to-action
- Never use placeholder text like [Your Name] or "Dear there"`;
  }

  async initializeAPI() {
    const apiKey = localStorage.getItem('ai_api_key');
    if (!apiKey) {
      const userKey = prompt('Enter your Claude API key to enable AI features:');
      if (userKey) {
        localStorage.setItem('ai_api_key', userKey);
        this.context.apiKey = userKey;
        return true;
      }
      return false;
    }
    this.context.apiKey = apiKey;
    return true;
  }

  async getAPIEndpoint() {
    // Try local proxy first, fallback to direct API
    try {
      const proxyResponse = await fetch('http://localhost:8080/health', { method: 'GET' });
      if (proxyResponse.ok) {
        return 'http://localhost:8080/api/anthropic';
      }
    } catch {
      // Proxy not available, use direct API
    }
    return 'https://api.anthropic.com/v1/messages';
  }

  async callClaudeAPI(prompt, systemPrompt = '') {
    if (!this.context.apiKey) {
      if (!await this.initializeAPI()) {
        return 'Please configure your API key to use AI features.';
      }
    }

    try {
      const apiUrl = await this.getAPIEndpoint();
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'x-api-key': this.context.apiKey,
          'anthropic-version': '2023-06-01',
          'content-type': 'application/json',
        },
        body: JSON.stringify({
          model: 'claude-3-haiku-20240307',
          max_tokens: 1000,
          system: systemPrompt || 'You are Claude, a helpful AI assistant for the Mad Science franchise CRM. Be friendly, conversational, and focused on helping with sales success and school outreach.',
          messages: [{
            role: 'user',
            content: prompt
          }]
        })
      });

      if (!response.ok) {
        const error = await response.text();
        throw new Error(`API Error: ${response.status} - ${error}`);
      }

      const data = await response.json();
      return data.content[0].text;
    } catch (error) {
      console.error('Claude API error:', error);
      throw new Error(`Failed to connect to Claude AI: ${error.message}`);
    }
  }

  updateContext() {
    // Get business schools (exclude staff)
    const businessSchools = DATA.filter(r => normalizeStatus(r.Status || r.status) !== 'staff');
    this.context.totalSchools = businessSchools.length;
    this.context.territories = TERRITORIES.map(t => t.name);
    this.context.currentTerritory = currentTerritory?.name;
    
    // Get selected groups
    const groupSel = document.getElementById('groupSel');
    this.context.selectedGroups = Array.from(groupSel.selectedOptions).map(o => o.value);
    
    // Calculate enhanced status distribution
    const dist = {none:0, firstoutreach:0, replied:0, inprogress:0, current:0, uninterested:0};
    const visible = markers.filter(m => {
      const st = normalizeStatus(m._rec.Status || m._rec.status);
      if (st === 'staff') return false;
      if (currentTerritory) return territoryVisible(m._rec);
      return baseVisiblePredicate(m._rec);
    });
    
    visible.forEach(m => {
      const st = normalizeStatus(m._rec.Status || m._rec.status);
      if (st !== 'staff') dist[st]++;
    });
    
    this.context.statusDistribution = dist;
    this.context.visibleSchools = visible.length;
    
    // CRM metrics
    const withContactInfo = visible.filter(m => {
      const rec = m._rec;
      return (rec.ContactName || rec.contactName || '').trim().length > 0 ||
             (rec.ContactEmail || rec.Email || rec.email || '').trim().length > 0;
    }).length;
    
    const withNotes = visible.filter(m => {
      const rec = m._rec;
      return (rec.Notes || rec.notes || '').trim().length > 0;
    }).length;
    
    const staleContacts = visible.filter(m => {
      const daysSince = daysSinceLastContact(m._rec);
      return daysSince !== null && daysSince > 14;
    }).length;
    
    this.context.crmMetrics = {
      withContactInfo,
      withNotes,
      staleContacts,
      dataCompleteness: Math.round((withContactInfo + withNotes) / (visible.length * 2) * 100)
    };
  }

  async processQuery(query) {
    // Store query
    this.context.lastQuery = query;
    this.context.history.push({ type: 'user', text: query });
    this.updateContext();

    // If API key is available, use Claude AI for ALL queries unless they are simple system commands
    if (this.context.apiKey) {
      // Build comprehensive context about current CRM state
      const visible = markers.filter(m => m && m._rec && map.hasLayer(m)).map(m => m._rec);
      const statusDist = this.context.statusDistribution;
      
      // Create rich context data
      const contextData = {
        totalSchools: DATA.length,
        visibleSchools: visible.length,
        statusDistribution: statusDist,
        territory: this.context.currentTerritory?.name || 'all territories',
        recentActivity: this.getRecentActivity(visible),
        topPriorities: this.getTopPriorities(visible),
        dataQuality: this.getDataQuality(visible)
      };

      // Create comprehensive system prompt with CRM context
      const systemPrompt = `You are Claude, an AI assistant helping manage a Mad Science franchise CRM system. 

Current CRM Context:
- Total schools in system: ${contextData.totalSchools}
- Currently viewing: ${contextData.visibleSchools} schools in ${contextData.territory}
- Status breakdown: ${Object.entries(statusDist).map(([k,v]) => `${k}: ${v}`).join(', ')}
- Data quality: ${contextData.dataQuality}

Key CRM Data Available:
- School names, addresses, contact information
- Status tracking (uncontacted, first outreach, replied, in progress, current clients, uninterested)
- Notes and activity history
- Territory and group classifications
- Email contact capabilities

You can help with:
- Analyzing sales patterns and conversion rates
- Suggesting follow-up strategies for specific schools
- Writing personalized emails for outreach
- Identifying growth opportunities
- Territory planning and optimization
- General business strategy and advice
- Any questions about the data or CRM functionality

Be conversational, helpful, and provide actionable insights. If asked about specific schools or data, reference the context provided. For email writing requests, ask for the school name if not specified.`;

      const prompt = `${query}

Current Context: ${JSON.stringify(contextData, null, 2)}

Recent conversation history:
${this.context.history.slice(-5).map(h => `${h.type}: ${h.text}`).join('\n')}`;

      try {
        const aiResponse = await this.callClaudeAPI(prompt, systemPrompt);
        return aiResponse;
      } catch (error) {
        console.error('Claude API error:', error);
        return `‚ùå Claude AI is temporarily unavailable: ${error.message}\n\nFalling back to built-in responses. Please check your API configuration in the AI Tools tab.`;
      }
    }

    // Fallback to pattern matching if no API key
    return this.getBuiltInResponse(query);
  }

  getRecentActivity(visible) {
    const withActivity = visible.filter(r => r.LastModified || r.Notes);
    return `${withActivity.length}/${visible.length} schools have recorded activity`;
  }

  getTopPriorities(visible) {
    const inProgress = visible.filter(r => normalizeStatus(r.Status) === 'inprogress').length;
    const replied = visible.filter(r => normalizeStatus(r.Status) === 'replied').length;
    return `${inProgress} in progress, ${replied} replied (high priority)`;
  }

  getDataQuality(visible) {
    const withEmail = visible.filter(r => r.ContactEmail || r.Email).length;
    const withContact = visible.filter(r => r.ContactName).length;
    return `${Math.round(withEmail/visible.length*100)}% have emails, ${Math.round(withContact/visible.length*100)}% have contact names`;
  }

  getBuiltInResponse(query) {
    const lowerQuery = query.toLowerCase();
    const visible = markers.filter(m => m && m._rec && map.hasLayer(m)).map(m => m._rec);
    const statusDist = this.context.statusDistribution;

    // Build context string
    let contextStr = this.context.currentTerritory || 'all territories';
    if (this.context.selectedGroups.length > 0) {
      contextStr += ` (${this.context.selectedGroups.join(', ')})`;
    }
    
    // Enhanced pattern matching for CRM queries
    
    if (lowerQuery.includes('how many') || lowerQuery.includes('count')) {
      return `There are ${this.context.totalSchools} business locations total (excluding staff). Currently showing ${this.context.visibleSchools} locations in ${contextStr}.`;
    }
    
    if (lowerQuery.includes('status') || lowerQuery.includes('breakdown') || lowerQuery.includes('pipeline')) {
      const dist = this.context.statusDistribution;
      return `CRM Pipeline for ${contextStr}:\n‚Ä¢ None: ${dist.none}\n‚Ä¢ First Outreach: ${dist.firstoutreach}\n‚Ä¢ Customer Replied: ${dist.replied}\n‚Ä¢ In Progress: ${dist.inprogress}\n‚Ä¢ Current Clients: ${dist.current}\n‚Ä¢ Uninterested: ${dist.uninterested}\n\nConversion Rate: ${Math.round((dist.current / this.context.visibleSchools) * 100)}%`;
    }
    
    if (lowerQuery.includes('data quality') || lowerQuery.includes('completeness') || lowerQuery.includes('crm data')) {
      const metrics = this.context.crmMetrics;
      return `CRM Data Quality for ${contextStr}:\n‚Ä¢ Contact Info: ${metrics.withContactInfo}/${this.context.visibleSchools} (${Math.round(metrics.withContactInfo/this.context.visibleSchools*100)}%)\n‚Ä¢ With Notes: ${metrics.withNotes}/${this.context.visibleSchools} (${Math.round(metrics.withNotes/this.context.visibleSchools*100)}%)\n‚Ä¢ Stale Contacts: ${metrics.staleContacts} (no activity >14 days)\n‚Ä¢ Overall Completeness: ${metrics.dataCompleteness}%`;
    }
    
    if (lowerQuery.includes('follow up') || lowerQuery.includes('overdue') || lowerQuery.includes('stale')) {
      const stale = this.context.crmMetrics.staleContacts;
      return `Follow-up Status for ${contextStr}:\n‚Ä¢ Stale Contacts: ${stale} locations with no activity >14 days\n‚Ä¢ Recommendation: ${stale > 0 ? `Focus on re-engaging these ${stale} contacts` : 'Good activity levels!'}\n\nTip: Use the "Show Stale Contacts" toggle to highlight them on the map.`;
    }
    
    if (lowerQuery.includes('contact') && (lowerQuery.includes('info') || lowerQuery.includes('email') || lowerQuery.includes('name'))) {
      const withInfo = this.context.crmMetrics.withContactInfo;
      return `Contact Information for ${contextStr}:\n‚Ä¢ ${withInfo}/${this.context.visibleSchools} locations have contact details (${Math.round(withInfo/this.context.visibleSchools*100)}%)\n‚Ä¢ Missing: ${this.context.visibleSchools - withInfo} locations need contact info\n\nTip: Click any location marker to add/edit contact information directly!`;
    }
    
    if (lowerQuery.includes('group') && this.context.selectedGroups.length > 0) {
      const groups = this.context.selectedGroups;
      const groupData = markers.filter(m => {
        const g = (m._rec.Group || m._rec.group || '').trim();
        return groups.includes(g) && (currentTerritory ? territoryVisible(m._rec) : baseVisiblePredicate(m._rec));
      });
      return `Selected group(s): ${groups.join(', ')}\nSchools in selection: ${groupData.length}\nThis represents ${Math.round(groupData.length/this.context.visibleSchools*100)}% of visible schools in ${this.context.currentTerritory || 'the current view'}.`;
    }
    
    if (lowerQuery.includes('recommend') || lowerQuery.includes('suggest') || lowerQuery.includes('priority')) {
      return this.generateCRMRecommendation();
    }
    
    // Default enhanced response
    return `I can help you with CRM insights:\n‚Ä¢ Pipeline analysis and status breakdowns\n‚Ä¢ Contact data quality assessment\n‚Ä¢ Follow-up recommendations\n‚Ä¢ Territory and group analysis\n‚Ä¢ Growth predictions\n\nCurrent context: ${contextStr}\n\nYour CRM data completeness: ${this.context.crmMetrics.dataCompleteness}%\nStale contacts: ${this.context.crmMetrics.staleContacts}\n\nTip: Click any location marker to update status, add contact info, and manage notes!\n\nWhat would you like to know?`;
  }

  generateCRMRecommendation() {
    const visible = markers.filter(m => {
      const st = normalizeStatus(m._rec.Status || m._rec.status);
      if (st === 'staff') return false;
      if (currentTerritory) return territoryVisible(m._rec);
      return baseVisiblePredicate(m._rec) && st !== 'staff';
    });
    
    const dist = this.context.statusDistribution;
    const metrics = this.context.crmMetrics;
    
    // Build context for recommendations
    let context = '';
    if (this.context.selectedGroups.length > 0) {
      context = ` for ${this.context.selectedGroups.join(', ')}`;
    }
    if (this.context.currentTerritory) {
      context += ` in ${this.context.currentTerritory}`;
    }
    
    if (visible.length === 0) {
      return `üìä No locations found${context}. Try adjusting your filters or selecting a different territory/group.`;
    }
    
    const recommendations = [];
    
    // Data quality recommendations
    if (metrics.dataCompleteness < 50) {
      recommendations.push(`üîß Data Priority: Improve CRM data quality (${metrics.dataCompleteness}% complete)`);
    }
    
    if (metrics.staleContacts > visible.length * 0.2) {
      recommendations.push(`‚è∞ Follow-up Priority: ${metrics.staleContacts} stale contacts need attention`);
    }
    
    // Pipeline recommendations
    if (dist.inprogress > visible.length * 0.15) {
      recommendations.push(`üíº Sales Priority: Focus on closing ${dist.inprogress} in-progress deals`);
    }
    
    if (dist.replied > visible.length * 0.2) {
      recommendations.push(`üìû Response Priority: Follow up with ${dist.replied} schools that replied`);
    }
    
    if (dist.none > visible.length * 0.4) {
      recommendations.push(`üìà Growth Priority: ${dist.none} uncontacted schools (${Math.round(dist.none/visible.length*100)}%) - huge opportunity`);
    }
    
    // Contact completeness
    if (metrics.withContactInfo < visible.length * 0.6) {
      recommendations.push(`üë§ Data Priority: Add contact info for ${visible.length - metrics.withContactInfo} locations`);
    }
    
    if (recommendations.length === 0) {
      recommendations.push(`‚úÖ Your CRM management${context} looks good! Consider expanding to new areas or deepening current relationships.`);
    }
    
    return `üìä CRM Recommendations${context}:\n\n${recommendations.slice(0, 3).map((r, i) => `${i+1}. ${r}`).join('\n')}\n\nOverall Status: ${dist.current} current clients, ${dist.inprogress + dist.replied} in pipeline, ${dist.none} untapped potential`;
  }

  async generateSmartEmail(school) {
    const context = this.buildEmailContext(school);
    const prompt = this.customPrompts.emailGeneration
      .replace('{schoolName}', context.school)
      .replace('{contactName}', context.contact)
      .replace('{status}', context.status)
      .replace('{daysSince}', context.daysSince || 'Never contacted')
      .replace('{notes}', context.notes)
      .replace('{territory}', context.territory)
      .replace('{group}', context.group);

    const email = await this.callClaudeAPI(prompt, this.customPrompts.systemInstructions);
    return {
      subject: this.generateSubjectLine(context),
      body: email,
      context: context
    };
  }

  buildEmailContext(school) {
    const schoolName = school.School || school.SchoolName || school.Name || 'School';
    const contactName = school.ContactName || school.contactName || 'Principal';
    const status = normalizeStatus(school.Status || 'none');
    const notes = (school.Notes || school.notes || '').slice(0, 200);
    const daysSince = daysSinceLastContact(school);
    const territory = this.context.currentTerritory || 'Unknown';
    const group = school.Group || school.group || 'None';

    return {
      school: schoolName,
      contact: contactName,
      status: status,
      notes: notes,
      daysSince: daysSince,
      territory: territory,
      group: group
    };
  }

  generateSubjectLine(context) {
    const lines = {
      'none': `Science Programs for ${context.school}`,
      'firstoutreach': `Following up - Science Programs for ${context.school}`,
      'replied': `Re: Science Programs for ${context.school}`,
      'inprogress': `Next Steps - ${context.school} Science Programs`,
      'current': `Program Update for ${context.school}`,
      'uninterested': `New Science Options for ${context.school}`
    };
    return lines[context.status] || `Science Programs for ${context.school}`;
  }
}

const enhancedAI = new EnhancedAIAssistant();

/* ===== GMAIL INTEGRATION ===== */

class GmailIntegration {
  constructor() {
    this.config = {
      apiKey: localStorage.getItem('gmail_api_key') || '',
      clientId: localStorage.getItem('gmail_client_id') || '',
    };
    this.gapi = null;
    this.isSignedIn = false;
    this.currentUser = null;
  }

  async initialize() {
    if (!this.config.apiKey || !this.config.clientId) {
      console.log('Gmail API not configured');
      return false;
    }

    try {
      // Load Google Identity Services
      if (!window.google?.accounts) {
        await this.loadGoogleIdentityServices();
      }

      // Initialize Google API
      await this.loadGoogleAPI();
      
      // Initialize OAuth
      this.initializeOAuth();
      
      return true;
    } catch (error) {
      console.error('Gmail initialization failed:', error);
      return false;
    }
  }

  async loadGoogleIdentityServices() {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://accounts.google.com/gsi/client';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  async loadGoogleAPI() {
    return new Promise((resolve, reject) => {
      if (window.gapi) {
        resolve();
        return;
      }
      
      const script = document.createElement('script');
      script.src = 'https://apis.google.com/js/api.js';
      script.onload = () => {
        window.gapi.load('client', resolve);
      };
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  initializeOAuth() {
    // Check if already signed in
    const savedToken = localStorage.getItem('gmail_access_token');
    if (savedToken) {
      this.handleSignIn(savedToken);
    }
  }

  handleCredentialResponse(response) {
    const credential = response.credential;
    localStorage.setItem('gmail_credential', credential);
    
    // Get access token for Gmail API
    this.requestAccessToken();
  }

  async requestAccessToken() {
    try {
      // Check if we're running on localhost or file://
      const isLocalFile = window.location.protocol === 'file:';
      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      
      if (isLocalFile) {
        // For file:// protocol, redirect to a simple web-based auth flow
        const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
          `client_id=${this.config.clientId}&` +
          `redirect_uri=urn:ietf:wg:oauth:2.0:oob&` +
          `scope=https://www.googleapis.com/auth/gmail.send&` +
          `response_type=code&` +
          `access_type=offline&` +
          `prompt=consent`;
        
        showToast('üîë Opening authorization page... Copy the code and paste it back here.');
        window.open(authUrl, '_blank');
        
        // Ask user to paste the authorization code
        setTimeout(() => {
          const authCode = prompt('Paste the authorization code from Google here:');
          if (authCode) {
            this.exchangeCodeForToken(authCode);
          } else {
            showToast('‚ùå Authorization cancelled');
          }
        }, 2000);
        
      } else {
        // Use the token client for localhost
        const client = google.accounts.oauth2.initTokenClient({
          client_id: this.config.clientId,
          scope: 'https://www.googleapis.com/auth/gmail.send',
          callback: (response) => {
            if (response.access_token) {
              localStorage.setItem('gmail_access_token', response.access_token);
              this.handleSignIn(response.access_token);
              showToast('‚úÖ Gmail authorization successful!');
            } else if (response.error) {
              console.error('OAuth error:', response.error);
              showToast('‚ùå Gmail authorization failed: ' + response.error);
            }
          },
        });
        
        client.requestAccessToken();
      }
    } catch (error) {
      console.error('Access token request failed:', error);
      showToast('‚ùå Gmail authorization failed: ' + error.message);
    }
  }

  async exchangeCodeForToken(authCode) {
    try {
      showToast('üîÑ Exchanging authorization code for access token...');
      
      // Note: This requires a server-side endpoint to exchange the code
      // For now, we'll show instructions to the user
      showToast('‚ö†Ô∏è Manual token exchange needed - check GMAIL_SETUP.md for instructions');
      
      // Alternative: Ask user to manually get token
      setTimeout(() => {
        const accessToken = prompt('This requires manual token exchange. If you have an access token, paste it here (or check GMAIL_SETUP.md):');
        if (accessToken) {
          localStorage.setItem('gmail_access_token', accessToken);
          this.handleSignIn(accessToken);
        }
      }, 1000);
      
    } catch (error) {
      console.error('Token exchange failed:', error);
      showToast('‚ùå Token exchange failed: ' + error.message);
    }
  }

  handleSignIn(accessToken) {
    this.isSignedIn = true;
    this.accessToken = accessToken;
    
    // Initialize Gmail API
    window.gapi.client.init({
      apiKey: this.config.apiKey,
      discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'],
    }).then(() => {
      window.gapi.client.setToken({ access_token: accessToken });
      this.updateGmailStatus();
      showToast('‚úÖ Gmail connected successfully!');
      
      // Update API status indicators
      if (window.updateAPIStatus) {
        window.updateAPIStatus();
      }
    });
  }

  signOut() {
    this.isSignedIn = false;
    this.accessToken = null;
    localStorage.removeItem('gmail_access_token');
    localStorage.removeItem('gmail_credential');
    this.updateGmailStatus();
    showToast('üì§ Signed out of Gmail');
    
    // Update API status indicators
    if (window.updateAPIStatus) {
      window.updateAPIStatus();
    }
  }

  updateGmailStatus() {
    // Update UI to show connection status
    const statusElements = document.querySelectorAll('.gmail-status');
    statusElements.forEach(el => {
      el.textContent = this.isSignedIn ? '‚úÖ Connected' : '‚ùå Not Connected';
      el.className = `gmail-status ${this.isSignedIn ? 'connected' : 'disconnected'}`;
    });
  }

  configure(apiKey, clientId) {
    this.config.apiKey = apiKey;
    this.config.clientId = clientId;
    localStorage.setItem('gmail_api_key', apiKey);
    localStorage.setItem('gmail_client_id', clientId);
    
    // Reinitialize with new config
    this.initialize();
  }

  async sendEmail(to, subject, body, school = null) {
    if (!this.isSignedIn) {
      throw new Error('Not signed in to Gmail');
    }

    try {
      const userProfile = {
        name: localStorage.getItem('user_name') || 'Your Name',
        phone: localStorage.getItem('user_phone') || '',
        email: localStorage.getItem('user_email') || ''
      };

      // Build email with signature
      const signature = `\n\nBest regards,\n${userProfile.name}\nMad Science Franchise${userProfile.phone ? `\nPhone: ${userProfile.phone}` : ''}${userProfile.email ? `\nEmail: ${userProfile.email}` : ''}`;
      
      const fullBody = body + signature;

      // Create email message
      const email = [
        `To: ${to}`,
        `Subject: ${subject}`,
        `Content-Type: text/plain; charset=utf-8`,
        '',
        fullBody
      ].join('\n');

      // Encode email
      const encodedEmail = btoa(unescape(encodeURIComponent(email)))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');

      // Send via Gmail API
      const response = await window.gapi.client.gmail.users.messages.send({
        userId: 'me',
        resource: {
          raw: encodedEmail
        }
      });

      // Update CRM data
      if (school) {
        this.logEmailActivity(school, subject);
      }

      return { success: true, messageId: response.result.id };
      
    } catch (error) {
      console.error('Email send failed:', error);
      return { success: false, error: error.message };
    }
  }

  logEmailActivity(school, subject) {
    const now = new Date().toISOString();
    
    // Update school record
    school.LastEmailSent = now;
    
    // Add to notes
    const emailNote = `üìß ${formatDate(new Date())}: Sent "${subject}"`;
    school.Notes = school.Notes ? `${school.Notes}\n${emailNote}` : emailNote;
    
    // Update status based on current status
    const currentStatus = normalizeStatus(school.Status);
    if (currentStatus === 'none') {
      school.Status = 'First Outreach';
    }
    
    // Update marker color
    const marker = markers.find(m => m._rec === school);
    if (marker) {
      updateMarkerStyle(marker);
    }
  }

  async generateEmail(school, templateType) {
    // Use AI to generate email
    const aiEmail = await enhancedAI.generateSmartEmail(school);
    return aiEmail;
  }

  createEmailInterface(school) {
    const hasEmail = school.ContactEmail || school.Email;
    
    if (!hasEmail) {
      return `<div class="email-section">
        <p style="color: #f44336; font-style: italic;">‚ö†Ô∏è Add contact email to enable email features</p>
      </div>`;
    }

    return `
      <div class="email-section">
        <button onclick="openEmailComposer('${school.School}')" class="btn btn-primary" style="margin-left: 10px;">
          üìß Send Email with AI
        </button>
        
        ${school.LastEmailSent ? 
          `<div class="last-email" style="margin-top: 8px; font-size: 12px; color: #666;">
             Last emailed: ${formatDate(new Date(school.LastEmailSent))}
           </div>` : ''
        }
      </div>
    `;
  }

  getEmailButton(school) {
    const hasEmail = school.ContactEmail || school.Email;
    
    if (!hasEmail) {
      return `<span style="color: #999; font-size: 12px;">‚ö†Ô∏è Add email to send</span>`;
    }

    return `<button onclick="openEmailComposer('${school.School}')" class="btn btn-primary">
      üìß Send Email with AI
    </button>`;
  }

  getLastEmailInfo(school) {
    if (school.LastEmailSent) {
      return `<div class="last-email" style="margin-top: 8px; font-size: 12px; color: #666; text-align: center;">
        Last emailed: ${formatDate(new Date(school.LastEmailSent))}
      </div>`;
    }
    return '';
  }
}

// Initialize Gmail integration
const gmailIntegration = new GmailIntegration();

// Helper function for date formatting
function formatDate(date) {
  if (!date) return '';
  const d = new Date(date);
  return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

// Helper function to update marker style based on status
function updateMarkerStyle(marker) {
  if (marker && marker._rec) {
    const color = getStatusColor(marker._rec);
    const icon = L.divIcon({
      className: 'custom-div-icon',
      html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3);"></div>`,
      iconSize: [12, 12],
      iconAnchor: [6, 6]
    });
    marker.setIcon(icon);
  }
}

// Helper function to close popup
function closePopup() {
  map.closePopup();
}

// Global functions for Gmail integration
async function sendQuickEmail(schoolName, templateType) {
  try {
    const school = DATA.find(s => s.School === schoolName || s.SchoolName === schoolName);
    if (!school) {
      showToast('‚ùå School not found');
      return;
    }
    
    if (!school.ContactEmail && !school.Email) {
      showToast('‚ùå No email address found for this school');
      return;
    }
    
    // Open the custom email composer with AI instructions pre-filled
    openEmailComposer(schoolName);
    
    // Add AI instructions based on template type
    setTimeout(() => {
      const instructionsTextarea = document.querySelector('[data-ai-instructions="true"]');
      if (instructionsTextarea) {
        let instructions = '';
        switch (templateType) {
          case 'introduction':
            instructions = 'Write a professional introduction email for Mad Science programs. This is our first contact with this school.';
            break;
          case 'followUp1':
            instructions = 'Write a friendly follow-up email. We previously sent them information about Mad Science programs but haven\'t heard back.';
            break;
          case 'replied':
            instructions = 'Write a response email. This school has replied to our previous outreach and shown interest.';
            break;
          default:
            instructions = 'Write a professional email about Mad Science programs for this school.';
        }
        instructionsTextarea.value = instructions;
        
        // Show the AI instructions section
        const aiSection = instructionsTextarea.closest('.ai-instructions-section');
        if (aiSection && aiSection.style.display === 'none') {
          const toggleBtn = document.querySelector('[onclick*="toggleAIInstructions"]');
          if (toggleBtn) toggleBtn.click();
        }
      }
      showToast('‚úÖ AI instructions pre-filled - customize and generate your email!');
    }, 100);
    
  } catch (error) {
    console.error('Quick email failed:', error);
    showToast(`‚ùå Error opening composer: ${error.message || 'Unknown error'}`);
  }
}

function openEmailComposer(schoolName) {
  const school = DATA.find(s => s.School === schoolName || s.SchoolName === schoolName);
  if (!school) return;
  
  // Create custom email composer popup
  const composer = document.createElement('div');
  composer.className = 'email-composer-popup';
  composer.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.5); z-index: 10000; display: flex;
    align-items: center; justify-content: center;
  `;
  
  composer.innerHTML = `
    <div class="email-composer" style="background: white; border-radius: 10px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
      <div class="composer-header" style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0;">üìß Compose Email - ${school.School || 'School'}</h3>
        <button onclick="this.closest('.email-composer-popup').remove()" style="background: none; border: none; font-size: 20px; cursor: pointer;">√ó</button>
      </div>
      
      <div class="composer-body" style="padding: 15px;">
        <div class="field" style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">To:</label>
          <input type="email" id="email-to" value="${school.ContactEmail || school.Email || ''}" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        
        <div class="field" style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">Subject:</label>
          <input type="text" id="email-subject" placeholder="Email subject..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        
        <div class="ai-instructions-section" style="margin-bottom: 15px; border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden;">
          <button onclick="toggleAIInstructions(this)" style="width: 100%; padding: 10px; background: #f8f9fa; border: none; text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
            <span>ü§ñ AI Instructions</span>
            <span class="toggle-icon">‚ñº</span>
          </button>
          <div class="instructions-content" style="padding: 15px; display: none;">
            <textarea data-ai-instructions="true" rows="3" placeholder="Customize instructions for the AI email generator..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
          </div>
        </div>
        
        <div class="field" style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">Message:</label>
          <textarea id="email-body" rows="10" placeholder="Email content will be generated here..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
        </div>
        
        <div class="composer-actions" style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button onclick="generateAIEmailDirect('${school.School}')" style="background: #9C27B0; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
            ü§ñ Generate AI Email
          </button>
          <button onclick="sendCustomEmail('${school.School}')" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
            üì§ Send Email
          </button>
          <button onclick="this.closest('.email-composer-popup').remove()" style="background: #ccc; color: black; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
            Cancel
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(composer);
}

function toggleAIInstructions(button) {
  const content = button.nextElementSibling;
  const icon = button.querySelector('.toggle-icon');
  
  if (content.style.display === 'none') {
    content.style.display = 'block';
    icon.textContent = '‚ñ≤';
  } else {
    content.style.display = 'none';
    icon.textContent = '‚ñº';
  }
}

async function generateAIEmailDirect(schoolName) {
  if (!enhancedAI.context.apiKey) {
    showToast('‚ùå Configure Claude API first');
    return;
  }
  
  const school = DATA.find(s => s.School === schoolName || s.SchoolName === schoolName);
  if (!school) return;
  
  const customInstructions = document.querySelector('[data-ai-instructions="true"]').value;
  
  // Build context for AI email generation
  const context = enhancedAI.buildEmailContext(school);
  
  // Use custom instructions if provided, otherwise use default
  let prompt = customInstructions || enhancedAI.customPrompts.emailGeneration;
  
  // Replace template variables
  prompt = prompt
    .replace(/{schoolName}/g, context.school)
    .replace(/{contactName}/g, context.contact)
    .replace(/{status}/g, context.status)
    .replace(/{daysSince}/g, context.daysSince || 'Never contacted')
    .replace(/{notes}/g, context.notes)
    .replace(/{territory}/g, context.territory)
    .replace(/{group}/g, context.group);

  try {
    showToast('ü§ñ Generating AI email...');
    
    const emailBody = await enhancedAI.callClaudeAPI(prompt, enhancedAI.customPrompts.systemInstructions);
    
    // Generate subject line
    const subject = `Science Programs for ${context.school}`;
    
    // Insert into form
    document.getElementById('email-subject').value = subject;
    document.getElementById('email-body').value = emailBody;
    
    showToast('‚úÖ AI email generated!');
    
  } catch (error) {
    console.error('AI email generation failed:', error);
    showToast(`‚ùå AI generation failed: ${error.message}`);
  }
}

async function sendCustomEmail(schoolName) {
  const school = DATA.find(s => s.School === schoolName || s.SchoolName === schoolName);
  if (!school) return;
  
  const to = document.getElementById('email-to').value;
  const subject = document.getElementById('email-subject').value;
  const body = document.getElementById('email-body').value;
  
  if (!to || !subject || !body) {
    showToast('‚ùå Please fill in all email fields');
    return;
  }
  
  try {
    showToast('üì§ Sending email...');
    
    const result = await gmailIntegration.sendEmail(to, subject, body, school);
    
    if (result.success) {
      showToast('‚úÖ Email sent successfully!');
      document.querySelector('.email-composer-popup').remove();
      
      // Update marker and refresh popup
      const marker = markers.find(m => m._rec === school);
      if (marker) {
        updateMarkerStyle(marker);
        if (marker.isPopupOpen()) {
          marker.setPopupContent(buildPopupHTML(school));
        }
      }
      
      updateInsights();
    } else {
      showToast(`‚ùå Email failed: ${result.error || 'Unknown error'}`);
    }
    
  } catch (error) {
    console.error('Email send failed:', error);
    showToast(`‚ùå Email send failed: ${error.message || 'Unknown error'}`);
  }
}

// AI Email Generation
function generateAIEmail(record) {
  const schoolName = record.School || record.SchoolName || record.Name || 'School';
  const contactName = record.ContactName || record.contactName || 'Principal';
  const contactEmail = record.ContactEmail || record.Email || record.email || '';
  const status = normalizeStatus(record.Status || 'none');
  const notes = record.Notes || record.notes || '';
  const daysSince = daysSinceLastContact(record);
  
  // Show AI panel and generate email preview
  document.getElementById('aiPanel').classList.add('active');
  const chat = document.getElementById('aiChat');
  
  // Build context-aware email
  let emailSubject = '';
  let emailBody = '';
  let emailContext = '';
  
  if (contactEmail) {
    emailContext = `üìß Ready to send to: ${contactEmail}`;
  } else {
    emailContext = `‚ö†Ô∏è No contact email on file - add one in the popup first`;
  }
  
  switch(status) {
    case 'none':
      emailSubject = `Science Programming Opportunity for ${schoolName}`;
      emailBody = `Dear ${contactName},

I hope this email finds you well. I'm reaching out to introduce our Mad Science educational programs that bring hands-on science learning directly to students at ${schoolName}.

Our interactive workshops align with curriculum standards while making science fun and accessible for all students. We specialize in creating memorable experiences that spark curiosity and deepen understanding of STEM concepts.

Programs we offer include:
‚Ä¢ In-class science workshops
‚Ä¢ School-wide science assemblies  
‚Ä¢ After-school programs
‚Ä¢ Professional development for teachers

I'd love to discuss how we can support ${schoolName}'s science education goals. Could we schedule a brief call this week to explore what would work best for your students?

Best regards,
[Your Name]
Mad Science Franchise`;
      break;
      
    case 'firstoutreach':
      emailSubject = `Following up - Science Programs for ${schoolName}`;
      emailBody = `Dear ${contactName},

I wanted to follow up on my previous message about Mad Science programming for ${schoolName}. ${daysSince ? `It's been ${daysSince} days since I first reached out, a` : 'A'}nd I'm still excited about the possibility of bringing engaging science education to your students.

${notes ? `Based on our previous discussion: "${notes.split('\n')[0]}"` : 'I understand how busy the school year can be'}, which is why our programs are designed to be turnkey solutions that enhance your curriculum without adding to your workload.

Many schools in your area have seen fantastic results with our hands-on approach to science learning. Students consistently report higher engagement and improved understanding of STEM concepts.

Would a brief 15-minute call work to discuss how we could customize a program for ${schoolName}? I'm available at your convenience.

Best regards,
[Your Name]
Mad Science Franchise`;
      break;
      
    case 'replied':
      emailSubject = `Next steps for ${schoolName} Science Programming`;
      emailBody = `Dear ${contactName},

Thank you for your response! I'm excited about the opportunity to work with ${schoolName}.

${notes ? `As we discussed: "${notes.split('\n').pop()}"` : 'Based on your interest in our programming'}, I'd like to provide more specific details about how our programs would work for your students.

Next steps I'd suggest:
‚Ä¢ Schedule a brief call to discuss your specific needs and timeline
‚Ä¢ Share program details and pricing tailored to your requirements
‚Ä¢ Arrange a demonstration if helpful

I can work around your schedule - would mornings or afternoons work better for a quick call this week?

Looking forward to partnering with ${schoolName}!

Best regards,
[Your Name]
Mad Science Franchise`;
      break;
      
    case 'inprogress':
      emailSubject = `Moving forward with ${schoolName} - Let's finalize details`;
      emailBody = `Dear ${contactName},

I hope you're well! ${daysSince ? `It's been ${daysSince} days since we last connected` : 'Following up on our conversation'}, and I wanted to check in on the science programming proposal for ${schoolName}.

${notes ? `From our last discussion: "${notes.split('\n').pop()}"` : 'I know you were considering the timing and logistics'}

To move forward, I just need:
‚Ä¢ Confirmation of preferred program dates
‚Ä¢ Final headcount for planning purposes  
‚Ä¢ Any specific curriculum connections you'd like emphasized

Many schools find it helpful to start with a smaller pilot program to see the student response. We could begin with one grade level and expand from there.

When would be a good time for a brief call to finalize the details? I'm excited to bring this engaging science programming to your students!

Best regards,
[Your Name]
Mad Science Franchise`;
      break;
      
    case 'current':
      emailSubject = `Checking in - ${schoolName} Science Programs`;
      emailBody = `Dear ${contactName},

I hope the science programming at ${schoolName} has been going well! ${daysSince ? `It's been ${daysSince} days since our last update` : 'I wanted to check in'} and see how everything is progressing.

${notes ? `Last time we spoke: "${notes.split('\n').pop()}"` : 'I\'d love to hear how the students are responding to the programs'}

A few things I wanted to touch base about:
‚Ä¢ How are the students responding to the current programming?
‚Ä¢ Any feedback from teachers or parents?
‚Ä¢ Interest in additional programs or expansion for next term?

Many schools find value in building on successful programs with advanced workshops or different grade levels. I'd love to discuss what additional opportunities might benefit ${schoolName}.

Would you have 10 minutes for a quick call this week? I always enjoy hearing about the students' experiences and exploring ways to enhance the programming.

Best regards,
[Your Name]
Mad Science Franchise`;
      break;
      
    default:
      emailSubject = `Science Programming for ${schoolName}`;
      emailBody = `Dear ${contactName},

I hope this email finds you well. I wanted to reach out about science programming opportunities for ${schoolName}.

Best regards,
[Your Name]
Mad Science Franchise`;
  }
  
  chat.innerHTML += `
    <div class="ai-message user">Generate email for ${schoolName}</div>
    <div class="ai-message assistant">
      ü§ñ <strong>AI Email Generator</strong><br><br>
      
      <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
        <strong>üìã Contact Context:</strong><br>
        ‚Ä¢ School: ${schoolName}<br>
        ‚Ä¢ Contact: ${contactName}<br>
        ‚Ä¢ Status: ${status.charAt(0).toUpperCase() + status.slice(1).replace(/([A-Z])/g, ' $1')}<br>
        ‚Ä¢ Last Activity: ${daysSince ? `${daysSince} days ago` : 'Never contacted'}<br>
        ${emailContext}<br><br>
        
        <strong>üìß Suggested Email:</strong><br><br>
        <div style="background: white; padding: 12px; border-left: 4px solid #6a1b9a; font-family: monospace; font-size: 12px;">
          <strong>To:</strong> ${contactEmail || '[Add contact email first]'}<br>
          <strong>Subject:</strong> ${emailSubject}<br><br>
          
          ${emailBody.split('\n').join('<br>')}
        </div>
      </div>
      
      <small>üí° <strong>Tips:</strong> This email is customized based on current status and activity. Edit contact info in the popup to improve personalization. Phase 2 will add one-click sending!</small>
    </div>
  `;
  
  chat.scrollTop = chat.scrollHeight;
}

// Natural Language Search
function performAISearch(query) {
  const lowerQuery = query.toLowerCase();
  const results = [];
  
  DATA.forEach(rec => {
    let score = 0;
    const name = (rec.School || rec.SchoolName || rec.Name || rec.LocationName || rec.Location || '').toLowerCase();
    const address = (rec.Address || '').toLowerCase();
    const group = (rec.Group || '').toLowerCase();
    const notes = (rec.Notes || '').toLowerCase();
    const contactName = (rec.ContactName || rec.contactName || '').toLowerCase();
    const contactEmail = (rec.ContactEmail || rec.Email || rec.email || '').toLowerCase();
    
    // Check for exact matches
    if (name.includes(lowerQuery)) score += 10;
    if (address.includes(lowerQuery)) score += 5;
    if (group.includes(lowerQuery)) score += 3;
    if (notes.includes(lowerQuery)) score += 4;
    if (contactName.includes(lowerQuery)) score += 6;
    if (contactEmail.includes(lowerQuery)) score += 6;
    
    // Check for individual words
    const words = lowerQuery.split(' ');
    words.forEach(word => {
      if (word.length > 2) {
        if (name.includes(word)) score += 2;
        if (address.includes(word)) score += 1;
        if (notes.includes(word)) score += 1;
        if (contactName.includes(word)) score += 2;
      }
    });
    
    // Enhanced status-based queries
    const status = normalizeStatus(rec.Status);
    if (lowerQuery.includes('uncontacted') && status === 'none') score += 8;
    if (lowerQuery.includes('first outreach') && status === 'firstoutreach') score += 8;
    if (lowerQuery.includes('replied') && status === 'replied') score += 8;
    if (lowerQuery.includes('in progress') && status === 'inprogress') score += 8;
    if (lowerQuery.includes('current') && status === 'current') score += 8;
    if (lowerQuery.includes('uninterested') && status === 'uninterested') score += 8;
    if (lowerQuery.includes('staff') && status === 'staff') score += 8;
    
    // CRM-specific queries
    if (lowerQuery.includes('with contact') && contactName.length > 0) score += 6;
    if (lowerQuery.includes('with email') && contactEmail.length > 0) score += 6;
    if (lowerQuery.includes('with notes') && notes.length > 0) score += 6;
    if (lowerQuery.includes('stale')) {
      const daysSince = daysSinceLastContact(rec);
      if (daysSince !== null && daysSince > 14) score += 8;
    }
    if (lowerQuery.includes('recent activity')) {
      const daysSince = daysSinceLastContact(rec);
      if (daysSince !== null && daysSince <= 7) score += 8;
    }
    
    if (score > 0) {
      results.push({rec, score});
    }
  });
  
  results.sort((a,b) => b.score - a.score);
  return results.slice(0, 10).map(r => r.rec);
}

/* Init */
async function init(){
  log('init ‚Üí territories');
  await loadTerritories();

  const params = new URLSearchParams(location.search);
  const file   = (params.get('file')||'').replace(/[^a-z0-9._-]/gi,'');
  let csvUrl   = SHEETS_ENDPOINT;
  if (file) csvUrl += (csvUrl.includes('?') ? '&' : '?') + 'file=' + file;
  const host = new URL(csvUrl, location.href).host;
  if (!/googleusercontent\.com$/i.test(host) && !/script\.google\.com$/i.test(host)) {
    csvUrl += (csvUrl.includes('?') ? '&' : '?') + 'v=' + Date.now();
  }

  log('init ‚Üí fetch CSV');
  const res  = await fetchWithTimeout(csvUrl, { cache: 'no-store', redirect: 'follow' }, 15000);
  if (!res.ok) throw new Error(`CSV HTTP ${res.status}`);
  const text = await res.text();

  const parsed=parseCSV(text); HEADER=parsed.header; DATA=parsed.rows; normalizeRecords(DATA);
  buildGroupList();

  log('init ‚Üí create markers');
  for (let i=0;i<DATA.length;i++){
    const r=DATA[i];
    if(isValidLatLon(r.lat,r.lon)){
      const m = addCircleFor(r);
      if (visiblePredicate(r)) m.addTo(map);
    }
  }
  
  // Initialize insights with a delay to ensure everything is loaded
  setTimeout(() => {
    updateInsights();
    log('Insights initialized');
  }, 200);
  
  log('init ‚Üê CRM system ready');
}

/* Enhanced UI Event Handlers */
document.addEventListener('DOMContentLoaded',()=>{
  init().catch(e=>{console.error(e); showToast('Data load error: '+e.message, 'error'); log('ERR '+e.message)});

  // Territory and filtering
  document.getElementById('territorySel').addEventListener('change', onTerritoryChange);
  document.getElementById('groupSel').addEventListener('change', updateFilter);
  document.querySelectorAll('.statusChk').forEach(cb=>{
    cb.addEventListener('change', updateFilter);
    // Add visual feedback for checked state
    cb.addEventListener('change', function() {
      const item = this.closest('.status-filter-item');
      if (this.checked) {
        item.classList.add('checked');
      } else {
        item.classList.remove('checked');
      }
    });
    // Initialize checked state
    if (cb.checked) {
      cb.closest('.status-filter-item').classList.add('checked');
    }
  });
  document.getElementById('showStaffToggle').addEventListener('change', updateFilter);
  document.getElementById('showStaleToggle').addEventListener('change', updateFilter);
  document.getElementById('btnSearch').addEventListener('click', updateFilter);
  document.getElementById('btnClearSearch').addEventListener('click',()=>{document.getElementById('searchBox').value=''; updateFilter()});
  document.getElementById('searchBox').addEventListener('keydown',e=>{if(e.key==='Enter') updateFilter()});
  document.getElementById('btnZoomFirst').addEventListener('click',()=>{
    const first=markers.find(m=> m && map.hasLayer(m)); 
    if(first) map.setView(first.getLatLng(),14);
  });

  // List view
  document.getElementById('btnToggleList').addEventListener('click',()=>{
    LIST_ON=!LIST_ON;
    document.getElementById('listContainer').style.display=LIST_ON?'block':'none';
    document.getElementById('btnToggleList').textContent=LIST_ON?'List View: ON':'List View: OFF';
    if(LIST_ON) updateList();
  });
  document.getElementById('groupSelectAll').addEventListener('click',()=>{
    const s=document.getElementById('groupSel'); 
    for(const o of s.options) o.selected=true; 
    updateFilter();
  });
  
  document.getElementById('groupClear').addEventListener('click',()=>{
    const s=document.getElementById('groupSel'); 
    for(const o of s.options) o.selected=false; 
    updateFilter();
  });

  // CSV downloads with CRM fields
  document.getElementById('btnDownloadAll').addEventListener('click', ()=>{
    const csv = toCSV(DATA, HEADER);
    const d   = new Date().toISOString().slice(0,10);
    download(`crm-data-all-${d}.csv`, csv);
  });

  document.getElementById('btnDownloadFiltered').addEventListener('click', ()=>{
    const filtered = DATA.filter(r => visiblePredicate(r));
    const csv = toCSV(filtered, HEADER);
    const d   = new Date().toISOString().slice(0,10);
    download(`crm-data-filtered-${d}.csv`, csv);
  });

  // Tab switching
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(`${tab.dataset.tab}-content`).classList.add('active');
    });
  });

  // Insights panel collapse
  document.getElementById('btnCollapseInsights').addEventListener('click', () => {
    const panel = document.getElementById('insightsPanel');
    const btn = document.getElementById('btnCollapseInsights');
    const isCollapsed = panel.classList.contains('is-collapsed');
    panel.classList.toggle('is-collapsed');
    btn.textContent = isCollapsed ? 'Collapse' : 'Expand';
  });

  // Enhanced AI Panel controls
  document.getElementById('btnToggleAI').addEventListener('click', () => {
    document.getElementById('aiPanel').classList.toggle('active');
  });
  
  document.getElementById('btnOpenAI').addEventListener('click', () => {
    document.getElementById('aiPanel').classList.add('active');
  });
  
  document.getElementById('btnCloseAI').addEventListener('click', () => {
    document.getElementById('aiPanel').classList.remove('active');
  });

  // Enhanced AI Chat with CRM context
  // Enhanced AI Chat with Claude integration
  const sendAIMessage = async () => {
    const input = document.getElementById('aiInput');
    const query = input.value.trim();
    if (!query) return;
    
    const chat = document.getElementById('aiChat');
    chat.innerHTML += `<div class="ai-message user">${query}</div>`;
    
    // Add loading indicator
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'ai-message assistant loading';
    loadingDiv.innerHTML = 'ü§ñ Claude is thinking...';
    chat.appendChild(loadingDiv);
    chat.scrollTop = chat.scrollHeight;
    
    input.value = '';
    input.disabled = true;
    
    try {
      const response = await enhancedAI.processQuery(query);
      chat.removeChild(loadingDiv);
      chat.innerHTML += `<div class="ai-message assistant">${response}</div>`;
    } catch (error) {
      chat.removeChild(loadingDiv);
      chat.innerHTML += `<div class="ai-message assistant error">‚ùå Error: ${error.message}</div>`;
    } finally {
      input.disabled = false;
      input.focus();
      chat.scrollTop = chat.scrollHeight;
    }
  };
  
  document.getElementById('aiSend').addEventListener('click', sendAIMessage);
  document.getElementById('aiInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') sendAIMessage();
  });

  // Initialize AI chat with welcome message
  const initializeAIChat = () => {
    const chat = document.getElementById('aiChat');
    const apiKey = localStorage.getItem('ai_api_key');
    
    if (apiKey) {
      chat.innerHTML = `
        <div class="ai-message assistant">
          üëã <strong>Hi! I'm Claude, your AI assistant for the Mad Science CRM!</strong><br><br>
          I'm connected and ready to help you with:
          <ul style="margin: 10px 0; padding-left: 20px;">
            <li>Analyzing your school data and sales patterns</li>
            <li>Writing personalized emails for outreach</li>
            <li>Suggesting follow-up strategies</li>
            <li>Territory planning and optimization</li>
            <li>General business questions and advice</li>
          </ul>
          Just ask me anything! For example: <em>"What schools should I follow up with?"</em> or <em>"Write an email for Dartmouth Elementary"</em>
          <br><br>
          <button onclick="clearAIChat()" style="background: #f5f5f5; border: 1px solid #ddd; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">üóëÔ∏è Clear Chat</button>
        </div>
      `;
    } else {
      chat.innerHTML = `
        <div class="ai-message assistant">
          ü§ñ <strong>Welcome to the AI Assistant</strong><br><br>
          To get started, please configure your Claude API key in the <strong>AI Tools</strong> tab above.
          <br><br>
          Once configured, I'll be able to help you with intelligent CRM insights, email writing, and data analysis.
          <br><br>
          <button onclick="clearAIChat()" style="background: #f5f5f5; border: 1px solid #ddd; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">üóëÔ∏è Clear Chat</button>
        </div>
      `;
    }
  };

  // Function to clear AI chat
  window.clearAIChat = () => {
    initializeAIChat();
    enhancedAI.context.history = [];
  };

  // Initialize chat on load
  initializeAIChat();

  // Function to update API status indicators
  window.updateAPIStatus = function updateAPIStatus() {
    // Claude API Status
    const claudeStatus = document.getElementById('claude-status');
    const hasClaudeAPI = localStorage.getItem('ai_api_key');
    if (hasClaudeAPI) {
      claudeStatus.textContent = '‚úÖ';
      claudeStatus.className = 'api-status active';
      claudeStatus.title = 'Claude API configured and ready';
    } else {
      claudeStatus.textContent = '‚ùå';
      claudeStatus.className = 'api-status inactive';
      claudeStatus.title = 'Claude API not configured';
    }

    // Gmail API Status
    const gmailStatus = document.getElementById('gmail-status');
    const hasGmailCreds = gmailIntegration.config.apiKey && gmailIntegration.config.clientId;
    const isAuthorized = gmailIntegration.isSignedIn;
    
    if (isAuthorized) {
      gmailStatus.textContent = '‚úÖ';
      gmailStatus.className = 'api-status active';
      gmailStatus.title = 'Gmail API configured and authorized';
    } else if (hasGmailCreds) {
      gmailStatus.textContent = '‚ö†Ô∏è';
      gmailStatus.className = 'api-status';
      gmailStatus.title = 'Gmail credentials set, authorization needed';
    } else {
      gmailStatus.textContent = '‚ùå';
      gmailStatus.className = 'api-status inactive';
      gmailStatus.title = 'Gmail API not configured';
    }

    // User Profile Status
    const profileStatus = document.getElementById('profile-status');
    const userName = localStorage.getItem('user_name');
    if (userName && userName !== 'Your Name') {
      profileStatus.textContent = '‚úÖ';
      profileStatus.className = 'api-status active';
      profileStatus.title = `Profile set for: ${userName}`;
    } else {
      profileStatus.textContent = '‚ùå';
      profileStatus.className = 'api-status inactive';
      profileStatus.title = 'User profile not set';
    }
  }

  // Initialize user profile from localStorage
  function initializeUserProfile() {
    // Set defaults if not already set
    if (!localStorage.getItem('user_name')) {
      localStorage.setItem('user_name', 'Your Name');
    }
    if (!localStorage.getItem('user_phone')) {
      localStorage.setItem('user_phone', '');
    }
    if (!localStorage.getItem('user_email')) {
      localStorage.setItem('user_email', '');
    }
  }

  // Initialize everything
  initializeUserProfile();
  updateAPIStatus();

  // Configuration functions
  window.configureClaudeAPI = () => {
    const currentKey = localStorage.getItem('ai_api_key') || '';
    const newKey = prompt('Enter your Claude API key from https://console.anthropic.com:', currentKey);
    
    if (newKey !== null) { // User didn't cancel
      if (newKey.trim()) {
        localStorage.setItem('ai_api_key', newKey.trim());
        enhancedAI.context.apiKey = newKey.trim();
        showToast('‚úÖ Claude API key saved successfully!');
        initializeAIChat(); // Refresh welcome message
        updateAPIStatus(); // Update status indicator
      } else {
        localStorage.removeItem('ai_api_key');
        enhancedAI.context.apiKey = '';
        showToast('üîë Claude API key cleared');
        initializeAIChat(); // Refresh welcome message
        updateAPIStatus(); // Update status indicator
      }
    }
  };

  window.configureGmailCredentials = () => {
    const currentApiKey = localStorage.getItem('gmail_api_key') || '';
    const currentClientId = localStorage.getItem('gmail_client_id') || '';
    
    const apiKey = prompt('Enter your Google API Key:', currentApiKey);
    if (apiKey === null) return; // User cancelled
    
    const clientId = prompt('Enter your Google Client ID (format: xxx.apps.googleusercontent.com):', currentClientId);
    if (clientId === null) return; // User cancelled
    
    if (apiKey && clientId) {
      gmailIntegration.configure(apiKey, clientId);
      showToast('‚úÖ Gmail credentials saved! Now click "üîë Authorize" to connect.');
      updateAPIStatus(); // Update status indicator
    } else {
      showToast('‚ö†Ô∏è Both API Key and Client ID are required');
    }
  };

  window.authorizeGmail = async () => {
    // Check if running from file:// protocol
    if (window.location.protocol === 'file:') {
      const useServer = confirm(
        '‚ö†Ô∏è Gmail OAuth doesn\'t work with file:// protocol.\n\n' +
        'To fix this:\n' +
        '1. Run "python serve.py" or "start_server.bat"\n' +
        '2. Open http://localhost:8000 instead\n' +
        '3. Add http://localhost:8000 to Google Cloud Console origins\n\n' +
        'Click OK to continue anyway (manual auth), or Cancel to stop.'
      );
      
      if (!useServer) {
        showToast('üìñ Check GMAIL_SETUP.md for detailed instructions');
        return;
      }
    }

    if (!gmailIntegration.config.apiKey || !gmailIntegration.config.clientId) {
      showToast('‚ö†Ô∏è Configure Gmail credentials first using "üìß Gmail Setup"');
      return;
    }

    try {
      showToast('üîë Starting Gmail authorization...');
      await gmailIntegration.initialize();
      await gmailIntegration.requestAccessToken();
    } catch (error) {
      console.error('Gmail authorization error:', error);
      showToast('‚ùå Authorization failed: ' + error.message);
      
      if (window.location.protocol === 'file:') {
        setTimeout(() => {
          showToast('üí° Tip: Use "python serve.py" to run on localhost:8000 for proper OAuth');
        }, 2000);
      }
    }
  };

  window.setUserProfile = () => {
    const currentName = localStorage.getItem('user_name') || '';
    const currentPhone = localStorage.getItem('user_phone') || '';
    const currentEmail = localStorage.getItem('user_email') || '';
    
    // Show current profile in the prompt
    const displayName = currentName === 'Your Name' ? '' : currentName;
    
    const name = prompt('Enter your name (for email signatures):', displayName);
    if (name === null) return; // User cancelled
    
    const phone = prompt('Enter your phone number (optional):', currentPhone);
    if (phone === null) return; // User cancelled
    
    const email = prompt('Enter your email address (optional):', currentEmail);
    if (email === null) return; // User cancelled
    
    // Save the values
    localStorage.setItem('user_name', name.trim() || 'Your Name');
    localStorage.setItem('user_phone', phone.trim() || '');
    localStorage.setItem('user_email', email.trim() || '');
    
    showToast('‚úÖ User profile updated!');
    updateAPIStatus(); // Update status indicator
  };

  // Enhanced AI Search
  document.getElementById('btnAISearch').addEventListener('click', () => {
    const query = document.getElementById('aiSearchBox').value.trim();
    if (!query) return;
    
    const results = performAISearch(query);
    if (results.length === 0) {
      showToast('No results found for: ' + query, 'error');
      return;
    }
    
    // Apply search results as filter
    const resultIds = new Set(results.map(r => r.Id || `${r.School}_${r.Address}`));
    baseVisiblePredicate = function(rec) {
      const recId = rec.Id || `${rec.School}_${rec.Address}`;
      return resultIds.has(recId);
    };
    applyFilters();
    
    showToast(`Found ${results.length} results for "${query}"`);
    
    // Zoom to first result - Fix: Use proper marker finding
    const first = markers.find(m => {
      if (!m || !m._rec) return false;
      const recId = m._rec.Id || `${m._rec.School}_${m._rec.Address}`;
      return resultIds.has(recId);
    });
    if (first) map.setView(first.getLatLng(), 12);
  });

  // Enhanced AI Analysis buttons
  document.getElementById('btnAnalyzeTerritory').addEventListener('click', () => {
    const groupSel = document.getElementById('groupSel');
    const hasGroups = groupSel.selectedOptions.length > 0;
    
    if (!currentTerritory && !hasGroups) {
      showToast('Please select a territory or group first', 'error');
      return;
    }
    
    updateInsights();
    showToast('CRM Analysis complete - check Insights panel');
  });

  document.getElementById('btnPredictGrowth').addEventListener('click', () => {
    const visible = markers.filter(m => {
      const st = normalizeStatus(m._rec.Status || m._rec.status);
      if (st === 'staff') return false;
      if (currentTerritory) return territoryVisible(m._rec);
      return baseVisiblePredicate(m._rec) && st !== 'staff';
    });
    
    const statusDist = {none:0, firstoutreach:0, replied:0, inprogress:0, current:0, uninterested:0};
    visible.forEach(m => {
      const st = normalizeStatus(m._rec.Status);
      statusDist[st]++;
    });
    
    const totalPipeline = statusDist.inprogress + statusDist.replied;
    const totalUncontacted = statusDist.none + statusDist.firstoutreach;
    const growthPotential = visible.length > 0 ? Math.round(totalUncontacted / visible.length * 100) : 0;
    
    // Build context
    const groupSel = document.getElementById('groupSel');
    const selectedGroups = Array.from(groupSel.selectedOptions).map(o => o.value);
    let context = '';
    if (selectedGroups.length > 0) {
      context = ` for ${selectedGroups.join(', ')}`;
    }
    if (currentTerritory) {
      context += ` in ${currentTerritory.name}`;
    }
    
    const prediction = `üìà Enhanced CRM Growth Prediction${context}:

Current Pipeline Analysis (excluding staff):
‚Ä¢ Active Pipeline: ${totalPipeline} locations
  - In Progress: ${statusDist.inprogress} (likely to close: ${Math.round(statusDist.inprogress * 0.7)})
  - Customer Replied: ${statusDist.replied} (potential: ${Math.round(statusDist.replied * 0.4)})
  
‚Ä¢ Growth Potential: ${totalUncontacted} locations (${growthPotential}%)
  - First Outreach: ${statusDist.firstoutreach} (warm leads)
  - Uncontacted: ${statusDist.none} (cold prospects)

‚Ä¢ Current Clients: ${statusDist.current} (retention focus)

Projected 90-Day Outcomes:
‚Ä¢ Probable Conversions: ${Math.round(statusDist.inprogress * 0.7 + statusDist.replied * 0.4)} new clients
‚Ä¢ Potential Additional: ${Math.round(statusDist.firstoutreach * 0.3 + statusDist.none * 0.15)} with focused effort
‚Ä¢ Total Projected Growth: ${Math.round(statusDist.inprogress * 0.7 + statusDist.replied * 0.4 + statusDist.firstoutreach * 0.3 + statusDist.none * 0.15)} new clients

Strategic Recommendation: ${
  totalPipeline > 10 ? 'Focus on closing active pipeline first' : 
  statusDist.firstoutreach > 5 ? 'Nurture warm leads from first outreach' :
  growthPotential > 40 ? 'High growth territory - increase outreach intensity' : 
  growthPotential > 20 ? 'Moderate opportunity - systematic outreach program' : 
  'Mature territory - focus on retention and referrals'
}

Next Actions:
1. ${totalPipeline > 0 ? `Follow up on ${totalPipeline} active pipeline opportunities` : 'Build pipeline with targeted outreach'}
2. ${statusDist.none > 5 ? `Launch outreach campaign for ${statusDist.none} uncontacted schools` : 'Maintain current contact schedule'}
3. ${statusDist.current > 0 ? `Retention strategy for ${statusDist.current} current clients` : 'Focus on initial client acquisition'}`;
    
    // Show in AI chat
    document.getElementById('aiPanel').classList.add('active');
    const chat = document.getElementById('aiChat');
    chat.innerHTML += `<div class="ai-message assistant">${prediction}</div>`;
    chat.scrollTop = chat.scrollHeight;
  });

  document.getElementById('btnGenerateReport').addEventListener('click', async () => {
    const report = [];
    report.push(`üìä **CRM Territory Analysis Report**`);
    report.push(`Generated: ${new Date().toLocaleDateString()}\n`);
    
    // Enhanced statistics with CRM data
    const businessData = DATA.filter(r => normalizeStatus(r.Status || r.status) !== 'staff');
    const staffData = DATA.filter(r => normalizeStatus(r.Status || r.status) === 'staff');
    
    report.push(`**Overall CRM Statistics:**`);
    report.push(`‚Ä¢ Total Business Locations: ${businessData.length} (+ ${staffData.length} staff excluded)`);
    report.push(`‚Ä¢ Active Territories: ${TERRITORIES.length}`);
    
    // Enhanced data quality metrics
    const withContactName = businessData.filter(r => (r.ContactName || r.contactName || '').trim().length > 0).length;
    const withContactEmail = businessData.filter(r => (r.ContactEmail || r.Email || r.email || '').trim().length > 0).length;
    const withNotes = businessData.filter(r => (r.Notes || r.notes || '').trim().length > 0).length;
    const withLastModified = businessData.filter(r => (r.LastModified || r.lastModified || '').trim().length > 0).length;
    
    report.push(`\n**CRM Data Quality:**`);
    report.push(`‚Ä¢ Contact Names: ${withContactName}/${businessData.length} (${Math.round(withContactName/businessData.length*100)}%)`);
    report.push(`‚Ä¢ Contact Emails: ${withContactEmail}/${businessData.length} (${Math.round(withContactEmail/businessData.length*100)}%)`);
    report.push(`‚Ä¢ Locations with Notes: ${withNotes}/${businessData.length} (${Math.round(withNotes/businessData.length*100)}%)`);
    report.push(`‚Ä¢ Activity Tracking: ${withLastModified}/${businessData.length} (${Math.round(withLastModified/businessData.length*100)}%)`);
    
    // Enhanced status breakdown
    const statusDist = {none:0, firstoutreach:0, replied:0, inprogress:0, current:0, uninterested:0};
    businessData.forEach(r => {
      const st = normalizeStatus(r.Status || r.status);
      statusDist[st]++;
    });
    
    report.push(`\n**CRM Pipeline Status:**`);
    report.push(`‚Ä¢ Uncontacted: ${statusDist.none} (${Math.round(statusDist.none/businessData.length*100)}%)`);
    report.push(`‚Ä¢ First Outreach: ${statusDist.firstoutreach} (${Math.round(statusDist.firstoutreach/businessData.length*100)}%)`);
    report.push(`‚Ä¢ Customer Replied: ${statusDist.replied} (${Math.round(statusDist.replied/businessData.length*100)}%)`);
    report.push(`‚Ä¢ In Progress: ${statusDist.inprogress} (${Math.round(statusDist.inprogress/businessData.length*100)}%)`);
    report.push(`‚Ä¢ Current Clients: ${statusDist.current} (${Math.round(statusDist.current/businessData.length*100)}%)`);
    report.push(`‚Ä¢ Uninterested: ${statusDist.uninterested} (${Math.round(statusDist.uninterested/businessData.length*100)}%)`);
    
    // Conversion metrics
    const conversionRate = Math.round(statusDist.current / businessData.length * 100);
    const pipelineRate = Math.round((statusDist.inprogress + statusDist.replied) / businessData.length * 100);
    report.push(`\n**Conversion Metrics:**`);
    report.push(`‚Ä¢ Overall Conversion Rate: ${conversionRate}%`);
    report.push(`‚Ä¢ Active Pipeline Rate: ${pipelineRate}%`);
    report.push(`‚Ä¢ Response Rate: ${Math.round((statusDist.replied + statusDist.inprogress + statusDist.current) / (businessData.length - statusDist.none) * 100)}%`);
    
    // Strategic recommendations
    report.push(`\n**Strategic CRM Recommendations:**`);
    if (withContactName < businessData.length * 0.5) {
      report.push(`‚Ä¢ HIGH PRIORITY: Improve contact data quality (only ${Math.round(withContactName/businessData.length*100)}% have contact names)`);
    }
    if (statusDist.inprogress > businessData.length * 0.1) {
      report.push(`‚Ä¢ SALES FOCUS: Close ${statusDist.inprogress} in-progress opportunities`);
    }
    if (statusDist.replied > businessData.length * 0.15) {
      report.push(`‚Ä¢ FOLLOW-UP FOCUS: Nurture ${statusDist.replied} schools that have replied`);
    }
    if (statusDist.none > businessData.length * 0.3) {
      report.push(`‚Ä¢ GROWTH OPPORTUNITY: ${statusDist.none} uncontacted schools represent significant expansion potential`);
    }
    if (withNotes < businessData.length * 0.4) {
      report.push(`‚Ä¢ DOCUMENTATION: Improve activity tracking - only ${Math.round(withNotes/businessData.length*100)}% have notes`);
    }
    
    report.push(`\n**Next Actions:**`);
    report.push(`‚Ä¢ Implement systematic follow-up schedule based on status`);
    report.push(`‚Ä¢ Focus data collection on missing contact information`);
    report.push(`‚Ä¢ Track activity timing for all customer interactions`);
    report.push(`‚Ä¢ Develop territory-specific strategies based on pipeline density`);
    
    const reportText = report.join('\n');
    
    // Create and download report
    const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `crm-analysis-report-${new Date().toISOString().slice(0,10)}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('Enhanced CRM Report generated and downloaded');
  });

  // Initialize Gmail integration
  if (gmailIntegration.config.apiKey && gmailIntegration.config.clientId) {
    gmailIntegration.initialize().then(() => {
      updateAPIStatus(); // Update status after initialization
    });
  }
  gmailIntegration.updateGmailStatus();
  updateAPIStatus(); // Initial status update

  // Initialize drag functionality for all panels
  initializeDragFunctionality();
});

// Drag functionality for moveable panels
function initializeDragFunctionality() {
  const draggableElements = [
    { panel: 'panel', header: 'panelHeader' },
    { panel: 'insightsPanel', header: 'insightsHeader' },
    { panel: 'aiPanel', header: 'aiHeader' }
  ];

  draggableElements.forEach(({ panel, header }) => {
    makeDraggable(panel, header);
  });
}

function makeDraggable(panelId, headerId) {
  const panel = document.getElementById(panelId);
  const header = document.getElementById(headerId);
  
  if (!panel || !header) return;

  let isDragging = false;
  let startX, startY, initialX, initialY;

  header.addEventListener('mousedown', (e) => {
    // Don't drag when clicking buttons
    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
      return;
    }

    isDragging = true;
    startX = e.clientX;
    startY = e.clientY;

    // Get current position
    const rect = panel.getBoundingClientRect();
    initialX = rect.left;
    initialY = rect.top;

    // Change cursor and prevent selection
    document.body.style.cursor = 'grabbing';
    document.body.style.userSelect = 'none';
    
    e.preventDefault();
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;

    const deltaX = e.clientX - startX;
    const deltaY = e.clientY - startY;

    const newX = initialX + deltaX;
    const newY = initialY + deltaY;

    // Keep panel within viewport bounds
    const maxX = window.innerWidth - panel.offsetWidth;
    const maxY = window.innerHeight - panel.offsetHeight;
    
    const clampedX = Math.max(0, Math.min(newX, maxX));
    const clampedY = Math.max(0, Math.min(newY, maxY));

    panel.style.left = clampedX + 'px';
    panel.style.top = clampedY + 'px';
    panel.style.right = 'auto';
    panel.style.bottom = 'auto';
  });

  document.addEventListener('mouseup', () => {
    if (isDragging) {
      isDragging = false;
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    }
  });
}
</script>
</body>
</html>