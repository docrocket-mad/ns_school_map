<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NS Schools Map (Live v10B)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<style>
  html, body, #map { height: 100%; margin: 0; }
  #panel {
    position: fixed; top: 20px; left: 20px; z-index: 9999; background: white;
    padding: 12px; border: 1px solid #ccc; border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15); font-family: system-ui, sans-serif;
    font-size: 13px; width: 360px; max-height: 84vh; overflow: auto;
  }
  #legend {
    position: fixed; bottom: 20px; left: 20px; z-index: 9999; background: white;
    padding: 10px 12px; border: 1px solid #ccc; border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15); font-family: system-ui, sans-serif; font-size: 13px;
  }
  button { cursor: pointer; }
</style>
</head>
<body>
<div id="map"></div>

<div id="panel">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
    <div style="font-weight:700; font-size:14px;">Filters & Tools</div>
    <button id="btnToggleList">List View: OFF</button>
  </div>

  <div id="listContainer" style="display:none; margin:10px 0; border:1px solid #ddd; border-radius:8px; max-height:220px; overflow:auto;">
    <div style="padding:6px 8px; font-weight:600; border-bottom:1px solid #eee;">Schools</div>
    <div id="schoolList" style="max-height:180px; overflow:auto;"></div>
  </div>

  <div style="margin-bottom:8px;">
    <div style="font-weight:600; margin-bottom:4px;">Status</div>
    <label><input type="checkbox" class="statusChk" value="none" checked> None</label><br>
    <label><input type="checkbox" class="statusChk" value="recent" checked> Recent</label><br>
    <label><input type="checkbox" class="statusChk" value="current" checked> Current</label>
  </div>

  <div style="margin-bottom:8px;">
    <div style="font-weight:600; margin-bottom:4px;">Group</div>
    <select id="groupSel" multiple size="7" style="width:100%;"></select>
    <div style="display:flex; gap:6px; margin-top:6px;">
      <button id="groupClear">Clear</button>
      <button id="groupSelectAll">Select all</button>
    </div>
  </div>

  <div style="margin-bottom:8px;">
    <div style="font-weight:600; margin-bottom:4px;">Search</div>
    <input id="searchBox" type="text" placeholder="School or address..." style="width:100%; padding:6px;">
    <div style="display:flex; gap:6px; margin-top:6px;">
      <button id="btnSearch">Apply</button>
      <button id="btnClearSearch">Clear</button>
      <button id="btnZoomFirst">Zoom to first</button>
    </div>
  </div>

  <hr style="margin:10px 0;">
  <div style="font-weight:700; margin-bottom:6px;">Add a School/Location</div>
  <div>Toggle ‚ÄúAdd Mode‚Äù to type an address (or click the map). Geocode to place the pin at the typed address.</div>
  <div style="margin-top:6px; display:flex; flex-direction:column; gap:6px;">
    <button id="btnAddMode">Add Mode: OFF</button>
    <input id="addAddress" type="text" placeholder="123 Main St, Town, NS" style="width:100%; padding:6px;">
    <div style="display:flex; gap:6px;">
      <button id="btnGeocode">Geocode address</button>
      <button id="btnUseClick">Use last clicked</button>
    </div>
  </div>

  <hr style="margin:10px 0;">
  <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
    <button id="btnUndoDelete" title="Undo the most recent delete">Undo Delete</button>
    <button id="btnDownloadAll" style="font-weight:700;">Download CSV (All)</button>
    <button id="btnDownloadFiltered" style="font-weight:700;">Download Filtered CSV</button>
  </div>

  <div id="toast" style="display:none; margin-top:8px; padding:6px 8px; background:#e8f5e9; color:#2e7d32; border:1px solid #c8e6c9; border-radius:6px;">Saved!</div>
</div>

<div id="legend">
  <div style="font-weight:700; margin-bottom:6px;">Status Legend</div>
  <div><span style="display:inline-block;width:12px;height:12px;background:#808080;margin-right:6px;border-radius:50%;"></span> None</div>
  <div><span style="display:inline-block;width:12px;height:12px;background:#1f77b4;margin-right:6px;border-radius:50%;"></span> Recent</div>
  <div><span style="display:inline-block;width:12px;height:12px;background:#2ca02c;margin-right:6px;border-radius:50%;"></span> Current</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
/* ===== Config ===== */
const SHEETS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwLziNp4LZSh1CMl0KcbjCZDM5d1TlX8BaAqT8A2uBd5eiHUEwVmYFNDMhM6G51Ele-lQ/exec"; // <-- paste from deployment
const COLOR = {none:"#808080", recent:"#1f77b4", current:"#2ca02c"};

/* ===== Map init ===== */
const map = L.map('map').setView([45.2, -62.99], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

/* ===== State ===== */
let DATA = [];              // live records {id, School, Address, Group, Phone, Email, lat, lon, Status}
let markers = [];           // [{marker, rec}]
let lastClickLL = null;
let UNDO_STACK = [];
let moveIndex = null;
let LIST_ON = false;
let GROUPS = [];

/* ===== Utilities ===== */
function uuid() { // simple UUID v4
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
    const r = crypto.getRandomValues(new Uint8Array(1))[0] & 15;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}
function normalizeStatus(s) {
  const v = String(s || '').trim().toLowerCase();
  if (v === 'recent') return 'recent';
  if (v === 'current' || v === 'active' || v === 'both') return 'current';
  return 'none';
}
function showToast(msg="Saved!") {
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.display = "block";
  setTimeout(() => t.style.display = "none", 1600);
}
function toCSVLines(rows, headers) {
  const lines = [headers.join(",")];
  rows.forEach(row => {
    const vals = headers.map(h => {
      let v = row[h] == null ? "" : String(row[h]).replace(/"/g,'""');
      if (/[",\n]/.test(v)) v = '"' + v + '"';
      return v;
    });
    lines.push(vals.join(","));
  });
  return lines;
}
function downloadCSV(name, rows) {
  const HEADERS = ["id","School","Address","Group","Phone","Email","lat","lon","Status"];
  const lines = toCSVLines(rows, HEADERS);
  const blob = new Blob([lines.join("\n")], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = name;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ===== Backend calls ===== */
async function saveRecord(rec) {
  const payload = {op:"upsert", record: rec};
  try {
    await fetch(SHEETS_ENDPOINT, {
      method: "POST",
      headers: {"Content-Type":"text/plain;charset=utf-8"},
      body: JSON.stringify(payload)
    });
  } catch (e) { console.warn("Save error", e); }
}

async function deleteRecordById(id) {
  const payload = {op:"delete", id};
  try {
    await fetch(SHEETS_ENDPOINT, {
      method: "POST",
      headers: {"Content-Type":"text/plain;charset=utf-8"},
      body: JSON.stringify(payload)
    });
  } catch (e) { console.warn("Delete error", e); }
}

/* ===== Filters + list ===== */
function groupSelInit() {
  const sel = document.getElementById('groupSel');
  sel.innerHTML = '';
  const uniq = new Set();
  DATA.forEach(r => { if (r.Group && String(r.Group).trim() !== '') uniq.add(String(r.Group)); });
  GROUPS = Array.from(uniq).sort();
  GROUPS.forEach(g => {
    const opt = document.createElement('option');
    opt.value = g; opt.textContent = g; opt.selected = false;
    sel.appendChild(opt);
  });
}
function visiblePredicate(rec) {
  const statuses = new Set(Array.from(document.querySelectorAll('.statusChk'))
    .filter(x => x.checked).map(x => x.value));
  const groupsSel = document.getElementById('groupSel');
  const groups = new Set(groupsSel ? Array.from(groupsSel.selectedOptions).map(o => o.value) : []);
  const q = (document.getElementById('searchBox').value || '').trim().toLowerCase();

  let show = statuses.has(normalizeStatus(rec.Status));
  if (show && groups.size > 0) {
    show = groups.has(rec.Group || '');
  }
  if (show && q) {
    const hay = ((rec.School||'') + ' ' + (rec.Address||'')).toLowerCase();
    show = hay.includes(q);
  }
  return show;
}
function rebuildList() {
  const wrap = document.getElementById('schoolList');
  if (!wrap) return;
  wrap.innerHTML = '';
  if (!LIST_ON) return;

  const rows = [];
  DATA.forEach((rec, idx) => {
    if (!Number.isFinite(rec.lat) || !Number.isFinite(rec.lon)) return;
    if (!visiblePredicate(rec)) return;
    rows.push({rec, idx});
  });
  rows.sort((a, b) => String(a.rec.School||'').localeCompare(String(b.rec.School||'')));

  if (!rows.length) {
    const empty = document.createElement('div');
    empty.textContent = "No schools match the current filters.";
    empty.style.cssText = "padding:8px; color:#666;";
    wrap.appendChild(empty);
    return;
  }

  rows.forEach(({rec, idx}) => {
    const item = document.createElement('div');
    item.style.cssText = "padding:8px; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; align-items:center; gap:8px;";
    const left = document.createElement('div');
    const phoneLine = rec.Phone ? `<div style="font-size:12px; color:#666;">üìû ${rec.Phone}</div>` : '';
    const emailLine = rec.Email ? `<div style="font-size:12px; color:#666;">‚úâÔ∏è ${rec.Email}</div>` : '';
    left.innerHTML = `<div style="font-weight:600">${rec.School || ''}</div>
                      <div style="font-size:12px; color:#666;">${rec.Group || ''}</div>
                      <div style="font-size:12px; color:#666;">${rec.Address || ''}</div>
                      ${phoneLine}${emailLine}`;
    const dot = document.createElement('span');
    dot.style.cssText = `display:inline-block;width:10px;height:10px;border-radius:50%;background:${COLOR[normalizeStatus(rec.Status)]}; flex:0 0 auto;`;
    item.appendChild(left);
    item.appendChild(dot);
    item.onclick = () => {
      const m = markers[idx] && markers[idx].marker;
      if (m) {
        const ll = m.getLatLng();
        map.setView(ll, 14);
        m.openPopup();
      }
    };
    wrap.appendChild(item);
  });
}

/* ===== Geocode (client) ===== */
async function geocodeClient(q) {
  if (!q) return null;
  const params = new URLSearchParams({
    format: "jsonv2",
    q,
    countrycodes: "ca",
    viewbox: "-66.5,47.2,-59.0,43.0", // west,north,east,south for NS
    bounded: "1",
    limit: "1",
    addressdetails: "0"
  });
  const url = "https://nominatim.openstreetmap.org/search?" + params.toString();
  try {
    const res = await fetch(url, { headers: { "Accept": "application/json" } });
    if (!res.ok) return null;
    const json = await res.json();
    if (Array.isArray(json) && json.length > 0) {
      const r = json[0];
      const lat = Number(r.lat), lon = Number(r.lon);
      if (Number.isFinite(lat) && Number.isFinite(lon)) return {lat, lon};
    }
  } catch (_) {}
  return null;
}

/* ===== Markers ===== */
function addCircleFor(rec, idx) {
  const color = COLOR[normalizeStatus(rec.Status)];
  const safeTel = (rec.Phone || '').replace(/[^+\d]/g,'');
  const firstEmail = (rec.Email || '').split(/[,\s;]+/).filter(Boolean)[0] || '';
  const phoneLine = rec.Phone ? `<div style="font-size:12px;">üìû <a href="tel:${safeTel}">${rec.Phone}</a></div>` : '';
  const emailLine = rec.Email ? `<div style="font-size:12px;">‚úâÔ∏è <a href="mailto:${firstEmail}">${rec.Email}</a></div>` : '';
  const html = `
    <div style='min-width:300px'>
      <div style="font-weight:700">${rec.School || ''}</div>
      <div style="font-size:12px; margin:4px 0;">${rec.Address || ''}</div>
      <div style="font-size:12px; color:#666;">${rec.Group || ''}</div>
      ${phoneLine}${emailLine}
      <hr/>
      <div style="font-size:12px; margin-bottom:6px;">Set status:</div>
      <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px;">
        <button onclick="window._setStatus(${idx}, 'none')" style="padding:4px 8px">None</button>
        <button onclick="window._setStatus(${idx}, 'recent')" style="padding:4px 8px">Recent</button>
        <button onclick="window._setStatus(${idx}, 'current')" style="padding:4px 8px">Current</button>
      </div>
      <div style="display:flex; gap:6px; justify-content:flex-end;">
        <button onclick="window._move(${idx})" style="padding:4px 8px;">Move pin</button>
        <button onclick="window._delete(${idx})" style="padding:4px 8px; color:#b00020;">Delete</button>
      </div>
    </div>`;
  const cm = L.circleMarker([rec.lat, rec.lon], {
    radius: 7, color: color, fillColor: color, fillOpacity: 0.9, weight: 2
  }).bindPopup(html);
  cm.addTo(map);
  markers.push({marker: cm, rec});
}
function rebuildMarkers() {
  markers.forEach(m => map.removeLayer(m.marker));
  markers = [];
  DATA.forEach((rec, idx) => {
    if (Number.isFinite(rec.lat) && Number.isFinite(rec.lon)) addCircleFor(rec, idx);
  });
  applyFilters();
}

/* ===== Actions ===== */
window._setStatus = async function(idx, status) {
  if (!DATA[idx]) return;
  DATA[idx].Status = normalizeStatus(status);
  const m = markers[idx] && markers[idx].marker;
  if (m) m.setStyle({color: COLOR[DATA[idx].Status], fillColor: COLOR[DATA[idx].Status]});
  applyFilters();
  saveRecord(DATA[idx]);
};
window._delete = async function(idx) {
  if (!DATA[idx]) return;
  const rec = DATA[idx];
  UNDO_STACK.push({type:'delete', rec: {...rec}, idx});
  DATA.splice(idx, 1);
  await deleteRecordById(rec.id);
  rebuildMarkers();
  showToast("Deleted. Click Undo Delete to restore.");
};
window._move = function(idx) {
  moveIndex = idx;
  showToast("Move mode: click on the map to set new location.");
};

/* ===== Filters/Search ===== */
function applyFilters() {
  let firstVisible = null;
  markers.forEach(({marker, rec}) => {
    const show = visiblePredicate(rec);
    if (show) {
      marker.addTo(map);
      if (!firstVisible) firstVisible = marker;
    } else {
      map.removeLayer(marker);
    }
  });
  rebuildList();
  return firstVisible;
}
function zoomFirst() {
  const first = applyFilters();
  if (first) {
    const ll = first.getLatLng();
    map.setView(ll, 14);
    first.openPopup();
  }
}

/* ===== Add Mode / Move / Undo ===== */
let addMode = false;
function toggleAddMode() {
  addMode = !addMode;
  document.getElementById('btnAddMode').textContent = "Add Mode: " + (addMode ? "ON" : "OFF");
}
function undoDelete() {
  if (!UNDO_STACK.length) { showToast("Nothing to undo."); return; }
  const action = UNDO_STACK.pop();
  if (action.type === 'delete') {
    const pos = Math.min(action.idx, DATA.length);
    DATA.splice(pos, 0, action.rec);
    saveRecord(action.rec); // reinsert in backend
    rebuildMarkers();
    showToast("Restored.");
  }
}
map.on('click', async (e) => {
  lastClickLL = e.latlng;
  if (moveIndex !== null) {
    const idx = moveIndex; moveIndex = null;
    if (DATA[idx]) {
      DATA[idx].lat = Number(e.latlng.lat.toFixed(6));
      DATA[idx].lon = Number(e.latlng.lng.toFixed(6));
      const m = markers[idx] && markers[idx].marker;
      if (m) m.setLatLng(e.latlng);
      applyFilters();
      saveRecord(DATA[idx]);
      showToast("Moved.");
    }
    return;
  }
  if (!addMode) return;
  openAddForm(lastClickLL.lat, lastClickLL.lng, "", "", "", "", "none");
});

async function geocodeToPoint(addr) {
  const ll = await geocodeClient(addr);
  if (ll) return [ll.lat, ll.lon];
  return null;
}

function openAddForm(lat, lon, usedAddress, usedGroup, usedPhone, usedEmail, usedStatus) {
  const form = document.createElement('div');
  form.style.cssText = "position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:12px; border:1px solid #ccc; border-radius:10px; z-index:10000; width:380px; box-shadow:0 2px 8px rgba(0,0,0,0.2); font-family:system-ui, sans-serif; font-size:13px;";
  form.innerHTML = `
    <div style="font-weight:700; margin-bottom:8px;">Add School/Location</div>
    <label>School<br><input id="f_school" style="width:100%" placeholder="Name"></label><br><br>
    <label>Address<br><input id="f_address" style="width:100%" placeholder="Street, Town, NS" value="${usedAddress || ''}"></label>
    <div style="display:flex; gap:6px; margin:6px 0 8px 0;">
      <button id="f_geocode">Geocode</button>
      <span id="f_geo_status" style="font-size:12px; color:#666;"></span>
    </div>
    <label>Group<br><input id="f_group" style="width:100%" placeholder="e.g., HRCE / AVRCE / CSAP / Private" value="${usedGroup || ''}"></label><br><br>
    <label>Phone<br><input id="f_phone" style="width:100%" placeholder="+1 902 ‚Ä¶" value="${usedPhone || ''}"></label><br><br>
    <label>Email(s)<br><input id="f_email" style="width:100%" placeholder="one or more, separated by ;" value="${usedEmail || ''}"></label><br><br>
    <label>Status<br>
      <select id="f_status" style="width:100%">
        <option value="none" ${usedStatus==='none'?'selected':''}>None</option>
        <option value="recent" ${usedStatus==='recent'?'selected':''}>Recent</option>
        <option value="current" ${usedStatus==='current'?'selected':''}>Current</option>
      </select>
    </label><br><br>
    <div>Lat: <span id="f_lat">${Number(lat).toFixed(6)}</span> &nbsp; Lon: <span id="f_lon">${Number(lon).toFixed(6)}</span></div>
    <div style="display:flex; gap:8px; margin-top:10px; justify-content:flex-end;">
      <button id="f_cancel">Cancel</button>
      <button id="f_save">Save</button>
    </div>
  `;
  document.body.appendChild(form);

  form.querySelector('#f_geocode').onclick = async () => {
    const q = form.querySelector('#f_address').value || '';
    form.querySelector('#f_geo_status').textContent = "Looking up‚Ä¶";
    const ll = await geocodeClient(q);
    if (ll) {
      form.querySelector('#f_lat').textContent = ll.lat.toFixed(6);
      form.querySelector('#f_lon').textContent = ll.lon.toFixed(6);
      form.querySelector('#f_geo_status').textContent = "Found ‚úì";
    } else {
      form.querySelector('#f_geo_status').textContent = "Not found (using map/cursor)";
    }
  };
  form.querySelector('#f_cancel').onclick = () => form.remove();
  form.querySelector('#f_save').onclick = async () => {
    const rec = {
      id: uuid(),
      School: form.querySelector('#f_school').value || 'New Location',
      Address: form.querySelector('#f_address').value || '',
      Group: form.querySelector('#f_group').value || '',
      Phone: form.querySelector('#f_phone').value || '',
      Email: form.querySelector('#f_email').value || '',
      lat: Number(form.querySelector('#f_lat').textContent),
      lon: Number(form.querySelector('#f_lon').textContent),
      Status: normalizeStatus(form.querySelector('#f_status').value || 'none')
    };
    DATA.push(rec);
    addCircleFor(rec, DATA.length - 1);
    // add group option if new
    if (rec.Group) {
      const sel = document.getElementById('groupSel');
      const exists = Array.from(sel.options).some(o => o.value === rec.Group);
      if (!exists) {
        const opt = document.createElement('option');
        opt.value = rec.Group; opt.textContent = rec.Group; opt.selected = false;
        sel.appendChild(opt);
      }
    }
    applyFilters();
    form.remove();
    showToast("Added!");
    saveRecord(rec);
  };
}

/* ===== Wiring ===== */
document.getElementById('btnToggleList').onclick = () => {
  LIST_ON = !LIST_ON;
  const btn = document.getElementById('btnToggleList');
  const box = document.getElementById('listContainer');
  btn.textContent = "List View: " + (LIST_ON ? "ON" : "OFF");
  box.style.display = LIST_ON ? "block" : "none";
  if (LIST_ON) rebuildList();
};
document.getElementById('groupClear').onclick = () => {
  const sel = document.getElementById('groupSel');
  Array.from(sel.options).forEach(o => o.selected = false);
  applyFilters();
};
document.getElementById('groupSelectAll').onclick = () => {
  const sel = document.getElementById('groupSel');
  Array.from(sel.options).forEach(o => o.selected = true);
  applyFilters();
};
Array.from(document.querySelectorAll('.statusChk')).forEach(cb =>
  cb.addEventListener('change', () => applyFilters())
);
document.getElementById('groupSel').addEventListener('change', () => applyFilters());
document.getElementById('btnSearch').onclick = () => applyFilters();
document.getElementById('btnClearSearch').onclick = () => { document.getElementById('searchBox').value=''; applyFilters(); };
document.getElementById('btnZoomFirst').onclick = () => zoomFirst();
document.getElementById('btnDownloadAll').onclick = () => downloadCSV("ns_schools_all.csv", DATA);
document.getElementById('btnDownloadFiltered').onclick = () => {
  const filtered = DATA.filter(r => Number.isFinite(r.lat) && Number.isFinite(r.lon) && visiblePredicate(r));
  downloadCSV("ns_schools_filtered.csv", filtered);
};
document.getElementById('btnUndoDelete').onclick = () => undoDelete();
document.getElementById('btnAddMode').onclick = () => toggleAddMode();

document.getElementById('btnGeocode').onclick = async () => {
  if (!addMode) toggleAddMode();
  const addr = (document.getElementById('addAddress').value || '').trim();
  if (!addr) { document.getElementById('addAddress').focus(); return; }
  const ll = await geocodeClient(addr);
  const base = ll || {lat: map.getCenter().lat, lon: map.getCenter().lng};
  openAddForm(base.lat, base.lon, addr, "", "", "", "none");
};
document.getElementById('btnUseClick').onclick = () => {
  if (!addMode) toggleAddMode();
  const base = lastClickLL ? {lat: lastClickLL.lat, lon: lastClickLL.lng} : {lat: map.getCenter().lat, lon: map.getCenter().lng};
  const addr = (document.getElementById('addAddress').value || '').trim();
  openAddForm(base.lat, base.lon, addr, "", "", "", "none");
};

/* ===== Boot: load data from Sheets, render ===== */
(async function init() {
  const raw = await apiGetAll();
  // sanitize + cast types
  DATA = raw.map(r => ({
    id: String(r.id || uuid()),
    School: String(r.School || ''),
    Address: String(r.Address || ''),
    Group: String(r.Group || ''),
    Phone: String(r.Phone || ''),
    Email: String(r.Email || ''),
    lat: Number(r.lat), lon: Number(r.lon),
    Status: normalizeStatus(r.Status)
  }));
  // backfill any missing ids to the sheet once
  const missing = DATA.filter(r => !raw.find(x => String(x.id||'') === r.id));
  missing.forEach(saveRecord);

  groupSelInit();
  DATA.forEach((rec, idx) => {
    if (Number.isFinite(rec.lat) && Number.isFinite(rec.lon)) addCircleFor(rec, idx);
  });
  applyFilters();
})();
</script>
</body>
</html>
