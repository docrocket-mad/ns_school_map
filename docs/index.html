<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NS Schools Map (Live v13.1)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  html, body, #map { height:100%; margin:0; }

  /* Panel */
  #panel {
    position:fixed; top:20px; left:20px; z-index:9999; background:#fff;
    padding:0; border:1px solid #ccc; border-radius:10px;
    box-shadow:0 2px 6px rgba(0,0,0,0.15);
    font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    font-size:13px; width:360px; max-height:86vh; overflow:hidden;
  }
  #panelHeader {
    display:flex; align-items:center; justify-content:space-between;
    padding:8px 10px; border-bottom:1px solid #e6e6e6; background:#f7f7f9;
  }
  #panelHeader .badge { background:#ffe08a; color:#7a4d00; font-weight:700; padding:2px 6px; border-radius:6px; }
  #panelHeader .title { font-weight:700; font-size:14px; display:flex; align-items:center; gap:8px; }
  #btnCollapsePanel { cursor:pointer; border:1px solid #ccc; border-radius:6px; background:#fff; padding:2px 6px; font-size:12px; }

  #panelBody { padding:12px; overflow:auto; max-height:calc(86vh - 40px); }
  #panel.is-collapsed #panelBody { display:none; }
  #panel.is-collapsed { max-height:unset; }

  /* Legend */
  #legend {
    position:fixed; bottom:20px; left:20px; z-index:9998; background:#fff;
    padding:10px 12px; border:1px solid #ccc; border-radius:10px;
    box-shadow:0 2px 6px rgba(0,0,0,0.15); font-family:system-ui; font-size:13px;
  }
  .swatch{display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:6px;vertical-align:-2px;}
  .list-item{padding:6px 8px;border-bottom:1px solid #eee;cursor:pointer;}
  .list-item:hover{background:#f6f8fa;}
  .leaflet-interactive.territory-boundary{pointer-events:none;}
  .muted{color:#666;}
  .row{display:flex;gap:6px;}
  .row>*{flex:1;}
  .popup-row{margin-top:6px}
  .popup-row select{padding:2px 4px; font-size:12px;}
  .popup-row button{padding:2px 6px; font-size:12px; cursor:pointer;}

  /* Toast */
  #toast {
    position:fixed;right:20px;bottom:20px;z-index:10000;
    padding:10px 12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.15);
    font:13px/1.3 system-ui;display:none;max-width:50vw;
  }

  /* Log (minimizable, doesn’t cover legend) */
  #log {
    position:fixed; right:20px; bottom:80px; z-index:10000;
    min-width:260px; max-width:45vw; max-height:30vh; overflow:auto;
    border-radius:8px; border:1px solid #e0e0e0; background:#fafafa; color:#333;
    font:12px/1.35 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    box-shadow:0 2px 6px rgba(0,0,0,.15);
  }
  #logHeader { display:flex; align-items:center; justify-content:space-between; padding:6px 8px; background:#f0f0f3; border-bottom:1px solid #e0e0e0; }
  #logBody { padding:6px 8px; }
  #btnToggleLog { border:1px solid #ccc; border-radius:6px; background:#fff; padding:2px 6px; font-size:12px; cursor:pointer; }

  @media (max-width: 600px) {
    #panel { width:92vw; left:4vw; top:12px; }
    #panelBody { max-height:calc(70vh - 40px); }
    #legend { left:12px; bottom:12px; }
    #toast { right:12px; bottom:12px; max-width:75vw; }
    #log { right:12px; bottom:80px; max-width:75vw; }
  }
</style>
</head>
<body>
<div id="map"></div>

<div id="panel">
  <div id="panelHeader">
    <div class="title">
      <span>Filters & Tools</span>
      <span class="badge">BUILD v13.1</span>
    </div>
    <button id="btnCollapsePanel" title="Collapse/Expand">Collapse</button>
  </div>

  <div id="panelBody">
    <div class="filter-block" style="margin-bottom:8px;">
      <label for="territorySel"><strong>Territory:</strong></label><br>
      <select id="territorySel">
        <option value="">-- Select a territory --</option>
      </select>
    </div>

    <div style="margin-bottom:8px;">
      <div style="font-weight:600; margin-bottom:4px;">Status</div>
      <label><input type="checkbox" class="statusChk" value="none" checked> None</label><br>
      <label><input type="checkbox" class="statusChk" value="recent" checked> Recent</label><br>
      <label><input type="checkbox" class="statusChk" value="current" checked> Current</label><br>
      <label><input type="checkbox" class="statusChk" value="staff" checked> Staff</label>
    </div>

    <div style="margin-bottom:8px;">
      <div style="font-weight:600; margin-bottom:4px;">Group</div>
      <select id="groupSel" multiple size="7" style="width:100%;"></select>
      <div class="row" style="margin-top:6px;">
        <button id="groupClear" type="button">Clear</button>
        <button id="groupSelectAll" type="button">Select all</button>
        <button id="btnToggleList" type="button">List View: OFF</button>
      </div>
    </div>

    <div style="margin-bottom:8px;">
      <div style="font-weight:600; margin-bottom:4px;">Search</div>
      <input id="searchBox" type="text" placeholder="School or address..." style="width:100%; padding:6px;">
      <div class="row" style="margin-top:6px;">
        <button id="btnSearch" type="button">Apply</button>
        <button id="btnClearSearch" type="button">Clear</button>
        <button id="btnZoomFirst" type="button">Zoom to first</button>
      </div>
    </div>

    <div id="listContainer" style="display:none; margin:10px 0; border:1px solid #ddd; border-radius:8px; max-height:220px; overflow:auto;">
      <div style="padding:6px 8px; font-weight:600; border-bottom:1px solid #eee;">Schools</div>
      <div id="schoolList" style="max-height:180px; overflow:auto;"></div>
    </div>

    <hr style="margin:10px 0;">

    <div class="row" style="align-items:center; flex-wrap:wrap;">
      <button id="btnDownloadAll" type="button" style="font-weight:700;">Download CSV (All)</button>
      <button id="btnDownloadFiltered" type="button" style="font-weight:700;">Download Filtered CSV</button>
    </div>
  </div>
</div>

<div id="legend">
  <div style="font-weight:700; margin-bottom:6px;">Status Legend</div>
  <div><span class="swatch" style="background:#808080;"></span> None</div>
  <div><span class="swatch" style="background:#1f77b4;"></span> Recent</div>
  <div><span class="swatch" style="background:#2ca02c;"></span> Current</div>
  <div><span class="swatch" style="background:#800080;"></span> Staff</div>
</div>

<div id="toast"></div>

<div id="log">
  <div id="logHeader">
    <strong>Log</strong>
    <button id="btnToggleLog" aria-expanded="true">Minimize</button>
  </div>
  <div id="logBody"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ===== CONFIG — SET THESE ===== */
const SHEETS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwLziNp4LZSh1CMl0KcbjCZDM5d1TlX8BaAqT8A2uBd5eiHUEwVmYFNDMhM6G51Ele-lQ/exec";  // GET CSV
const WRITE_ENDPOINT  = "https://script.google.com/macros/s/AKfycbwLziNp4LZSh1CMl0KcbjCZDM5d1TlX8BaAqT8A2uBd5eiHUEwVmYFNDMhM6G51Ele-lQ/exec";  // POST update (status only)
const WRITE_SECRET    = "123456pooydiapers";
const SHEET_TAB_NAME  = "Sheet1";
const TERRITORIES_URL = "territories.json";
const COLOR = { none:"#808080", recent:"#1f77b4", current:"#2ca02c", staff:"#800080" };

/* ===== Map ===== */
const map = L.map('map').setView([45.2, -62.99], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

/* ===== Log/Toast ===== */
function log(msg){
  const el=document.getElementById('logBody');
  const t=new Date().toLocaleTimeString();
  el.insertAdjacentHTML('beforeend', `<div><b>${t}</b> ${msg}</div>`);
  el.scrollTop=el.scrollHeight;
}
function showToast(msg, kind='ok'){
  const t=document.getElementById('toast');
  if(kind==='error'){t.style.background='#fdecea';t.style.border='1px solid #f5c2c0';t.style.color='#b71c1c';}
  else {t.style.background='#e8f5e9';t.style.border='1px solid #c8e6c9';t.style.color='#2e7d32';}
  t.textContent=msg; t.style.display='block'; clearTimeout(t._hideTimer);
  t._hideTimer=setTimeout(()=>{t.style.display='none';},3200);
}

/* Log minimize */
document.getElementById('btnToggleLog').addEventListener('click',()=>{
  const btn = document.getElementById('btnToggleLog');
  const body= document.getElementById('logBody');
  const isOpen = btn.getAttribute('aria-expanded') === 'true';
  if(isOpen){ body.style.display='none'; btn.textContent='Expand'; btn.setAttribute('aria-expanded','false'); }
  else { body.style.display='block'; btn.textContent='Minimize'; btn.setAttribute('aria-expanded','true'); }
});

/* Panel collapse (session-persisted) */
(function setupPanelCollapse(){
  const panel = document.getElementById('panel');
  const btn = document.getElementById('btnCollapsePanel');
  const KEY = 'panelCollapsed';
  function apply(state){ panel.classList.toggle('is-collapsed', !!state); btn.textContent = state ? 'Expand' : 'Collapse'; btn.setAttribute('aria-expanded', String(!state)); }
  const saved = sessionStorage.getItem(KEY) === '1';
  apply(saved);
  btn.addEventListener('click',()=>{
    const newState = !panel.classList.contains('is-collapsed');
    sessionStorage.setItem(KEY, newState ? '1' : '0');
    apply(newState);
  });
})();

/* Safety */
window.addEventListener('error', (e)=>{ log('Error: '+ (e && e.message ? e.message : e)); showToast('JS error: '+(e && e.message ? e.message : 'unknown'), 'error'); });
window.addEventListener('unhandledrejection', (e)=>{ log('Promise rejection: '+ (e && e.reason ? e.reason : e)); showToast('Unhandled rejection', 'error'); });

/* Utilities */
async function fetchWithTimeout(url, options={}, ms=15000){
  const ctrl = new AbortController();
  const id = setTimeout(()=>ctrl.abort(), ms);
  try{ return await fetch(url, { ...options, signal: ctrl.signal }); }
  finally{ clearTimeout(id); }
}

/* CSV */
function splitCSVLine(line){const out=[];let cur='',q=false;for(let i=0;i<line.length;i++){const c=line[i];if(c==='"'){if(q&&line[i+1]==='"'){cur+='"';i++}else q=!q}else if(c===','&&!q){out.push(cur);cur=''}else cur+=c}out.push(cur);return out}
function parseCSV(text){const clean=text.replace(/^\uFEFF/,'').replace(/\r\n/g,'\n');const lines=clean.split('\n').filter(l=>l.trim());if(!lines.length)return{header:[],rows:[]};const header=splitCSVLine(lines[0]).map(h=>h.trim());const rows=lines.slice(1).map(line=>{const cols=splitCSVLine(line);const rec={};header.forEach((h,i)=>rec[h]=(cols[i]??'').trim());return rec});return{header,rows}}

/* Geometry */
function bboxOfRing(r){let w=Infinity,s=Infinity,e=-Infinity,n=-Infinity;for(const[lon,lat]of r){if(lon<w)w=lon;if(lon>e)e=lon;if(lat<s)s=lat;if(lat>n)n=lat}return[w,s,e,n]}
function expandBBox(b,a){if(!b)return a.slice();if(a[0]<b[0])b[0]=a[0];if(a[1]<b[1])b[1]=a[1];if(a[2]>b[2])b[2]=a[2];if(a[3]>b[3])b[3]=a[3];return b}
function bboxOfPolygon(p){return bboxOfRing(p[0])}
function bboxOfGeometry(g){if(!g)return null;if(g.type==='Polygon')return bboxOfPolygon(g.coordinates);if(g.type==='MultiPolygon'){let b=null;for(const p of g.coordinates)b=expandBBox(b,bboxOfPolygon(p));return b}return null}
function pointInRing(x,y,ring){let inside=false;for(let i=0,j=ring.length-1;i<ring.length;j=i){const[xi,yi]=ring[i],[xj,yj]=ring[j];const inter=((yi>y)!=(yj>y))&&(x<(xj-xi)*(y-yi)/((yj-yi)||1e-12)+xi);if(inter)inside=!inside}return inside}
function pointInGeometry(x,y,g){if(!g)return false;if(g.type==='Polygon'){const r=g.coordinates;if(!pointInRing(x,y,r[0]))return false;for(let i=1;i<r.length;i++)if(pointInRing(x,y,r[i]))return false;return true}if(g.type==='MultiPolygon'){for(const p of g.coordinates){const r=p;if(!pointInRing(x,y,r[0]))continue;let ok=true;for(let i=1;i<r.length;i++)if(pointInRing(x,y,r[i])){ok=false;break}if(ok)return true}}return false}

/* State */
let DATA=[], HEADER=[], markers=[], LIST_ON=false;
let GROUPS=[], TERRITORIES=[], currentTerritory=null, territoryLayer=null;

/* Normalize */
function normalizeRecords(rows){
  const latKeys=['lat','Lat','LAT','latitude','Latitude','LATITUDE','y','Y'];
  const lonKeys=['lon','Lon','LON','lng','Lng','LNG','long','Long','LONG','longitude','Longitude','LONGITUDE','x','X'];
  rows.forEach(r=>{
    let lat=null,lon=null;
    for(const k of latKeys) if(r[k]&&lat===null){const v=parseFloat(r[k]); if(Number.isFinite(v)) lat=v}
    for(const k of lonKeys) if(r[k]&&lon===null){const v=parseFloat(r[k]); if(Number.isFinite(v)) lon=v}
    if(Number.isFinite(lat)) r.lat=lat;
    if(Number.isFinite(lon)) r.lon=lon;
    const raw=(r.active??r.Active??r.ACTIVE??'').toString().trim().toUpperCase();
    r.active = raw==='' ? true : !(raw==='FALSE'||raw==='0'||raw==='NO'||raw==='N');
    if(r.Id && !Number.isFinite(r.Id)){const n=parseFloat(r.Id); if(Number.isFinite(n)) r.Id=n}
  });
}
function isValidLatLon(lat,lon){return Number.isFinite(lat)&&Number.isFinite(lon)&&lat>=-90&&lat<=90&&lon>=-180&&lon<=180}
function normalizeStatus(s){s=(s||'').toLowerCase().trim(); if(!['none','recent','current','staff'].includes(s)) s='none'; return s}
function getStatusColor(r){return COLOR[normalizeStatus(r.Status||r.status)]||COLOR.none}

/* Territories */
async function loadTerritories(){
  const res = await fetch(TERRITORIES_URL, {cache:'no-store'});
  if(!res.ok) throw new Error('Territories HTTP '+res.status);
  const list = await res.json();
  TERRITORIES = Array.isArray(list)? list : [];
  TERRITORIES.forEach(t=>{ if(!t.id){t.id=(t.name||'territory').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'')} if(!t.bbox) t.bbox=bboxOfGeometry(t.geometry) });
  const sel=document.getElementById('territorySel');
  while(sel.options.length>1) sel.remove(1);
  TERRITORIES.forEach(t=>{const opt=document.createElement('option'); opt.value=t.id; opt.textContent=t.name||t.id; sel.appendChild(opt)});
}
function onTerritoryChange(){
  const id=document.getElementById('territorySel').value;
  currentTerritory = id ? TERRITORIES.find(t=>t.id===id) : null;
  if(territoryLayer){map.removeLayer(territoryLayer); territoryLayer=null}
  if(currentTerritory){
    territoryLayer=L.geoJSON(currentTerritory.geometry,{style:{color:currentTerritory.color||'#555',weight:1,opacity:0.8,dashArray:'4,6',fillColor:currentTerritory.color||'#555',fillOpacity:0.08},interactive:false,className:'territory-boundary'}).addTo(map);
    const b=currentTerritory.bbox; if(b){const[w,s,e,n]=b; map.fitBounds([[s,w],[n,e]])}
  }
  requestAnimationFrame(applyFilters);
}

/* Filtering */
let baseVisiblePredicate = rec => true;
function updateFilter(){
  const statusSet=new Set(Array.from(document.querySelectorAll('.statusChk')).filter(cb=>cb.checked).map(cb=>cb.value));
  const groupSel=document.getElementById('groupSel');
  const groupSet=new Set(Array.from(groupSel.selectedOptions).map(o=>o.value));
  const q=(document.getElementById('searchBox').value||'').trim().toLowerCase();
  baseVisiblePredicate=function(rec){
    if(rec.active===false) return false;
    if(statusSet.size && !statusSet.has(normalizeStatus(rec.Status||rec.status))) return false;
    if(groupSet.size){const g=(rec.Group||rec.group||'').trim(); if(!groupSet.has(g)) return false;}
    if(q){const hay=((rec.School||rec.SchoolName||rec.Name||'')+' '+(rec.Address||'')+' '+(rec.Group||'')).toLowerCase(); if(!hay.includes(q)) return false;}
    return true;
  };
  requestAnimationFrame(()=>{ applyFilters(); if(LIST_ON) updateList(); });
}
function territoryVisible(rec){
  if(!currentTerritory) return false;            // show nothing until a territory is selected
  if(!baseVisiblePredicate(rec)) return false;
  if(!Number.isFinite(rec.lat)||!Number.isFinite(rec.lon)) return false;
  if(rec.TerritoryId) return rec.TerritoryId===currentTerritory.id;
  const geo=currentTerritory.geometry, b=currentTerritory.bbox||bboxOfGeometry(geo);
  if(b){const[w,s,e,n]=b; if(rec.lon<w||rec.lon>e||rec.lat<s||rec.lat>n) return false;}
  return pointInGeometry(rec.lon,rec.lat,geo);
}
let visiblePredicate = territoryVisible;
function applyFilters(){
  for (let i=0; i<markers.length; i++){
    const m = markers[i];
    const show = visiblePredicate(m._rec);
    if(show){
      if(!map.hasLayer(m)) m.addTo(map);
      const col=getStatusColor(m._rec);
      m.setStyle({color:col, fillColor:col});
    } else {
      if(map.hasLayer(m)) map.removeLayer(m);
    }
  }
}

/* Popups (status change only) */
function formatPhone(p){const raw=String(p||'').trim(); if(!raw) return ''; const digits=raw.replace(/[^\d+]/g,''); return `<a href="tel:${digits}">${raw}</a>`}
function formatEmail(e){const raw=String(e||'').trim(); if(!raw) return ''; return `<a href="mailto:${raw}">${raw}</a>`}
function buildPopupHTML(rec){
  const name=rec.School||rec.SchoolName||rec.Name||'School';
  const addr=rec.Address||rec.address||'';
  const phone=rec.Phone||rec.phone||rec.Telephone||rec['Phone Number']||rec['Contact Phone']||'';
  const email=rec.Email||rec.email||rec['Email Address']||rec['Contact Email']||'';
  const group=(rec.Group||rec.group||'').trim();
  const st=normalizeStatus(rec.Status||rec.status);
  const phoneHTML=phone?`<br>Phone: ${formatPhone(phone)}`:'';
  const emailHTML=email?`<br>Email: ${formatEmail(email)}`:'';
  const groupHTML=group?`<br>Group: ${group}`:'';
  const select = `
    <select data-role="status-select">
      <option value="none"${st==='none'?' selected':''}>none</option>
      <option value="recent"${st==='recent'?' selected':''}>recent</option>
      <option value="current"${st==='current'?' selected':''}>current</option>
      <option value="staff"${st==='staff'?' selected':''}>staff</option>
    </select>`;
  const canUpdateKey = !!(rec.Id || ((rec.School||rec.SchoolName||rec.Name) && rec.Address));
  const btn = `<button data-role="save-status" ${canUpdateKey?'':'disabled'}>${canUpdateKey?'Save':'Save (no key)'}</button>`;
  const tip = canUpdateKey ? '' : `<div class="muted" style="margin-top:4px;">Add an <strong>Id</strong> column or ensure School & Address exist to enable updates.</div>`;
  return `<div><strong>${name}</strong><br>${addr}${groupHTML}${phoneHTML}${emailHTML}</div>
          <div class="popup-row">Status: ${select} ${btn}</div>${tip}`;
}
function addCircleFor(rec){
  const m=L.circleMarker([rec.lat,rec.lon],{radius:6,color:getStatusColor(rec),fillColor:getStatusColor(rec),fillOpacity:0.9,weight:1});
  m._rec=rec;
  m.on('click',()=>{
    const html = buildPopupHTML(rec);
    m.bindPopup(html).openPopup();
    setTimeout(()=>{
      const container = document.querySelector('.leaflet-popup-content');
      const sel = container && container.querySelector('[data-role="status-select"]');
      const btn = container && container.querySelector('[data-role="save-status"]');
      if (!sel || !btn) return;
      btn.addEventListener('click', async ()=>{
        const newSt = sel.value;
        const oldSt = normalizeStatus(rec.Status||rec.status);
        if (newSt === oldSt) return;
        rec.Status = newSt; // optimistic color change
        m.setStyle({ color: getStatusColor(rec), fillColor: getStatusColor(rec) });
        const keyField = rec.Id ? 'Id' : 'School+Address';
        const keyValue = rec.Id ? String(rec.Id) : JSON.stringify({ School: (rec.School||rec.SchoolName||rec.Name||''), Address: (rec.Address||'') });
        try{
          const res = await updateRowInSheet({ keyField, keyValue, patch: { Status: newSt } });
          log('status saved row '+(res && res.rowNumber ? res.rowNumber : '?'));
          m.setPopupContent(buildPopupHTML(rec));
          showToast('Status saved');
        }catch(err){
          log('update FAIL http? see console: '+(err && err.message ? err.message : err));
          showToast('Could not save status, reverting','error');
          rec.Status = oldSt;
          m.setStyle({ color: getStatusColor(rec), fillColor: getStatusColor(rec) });
          m.setPopupContent(buildPopupHTML(rec));
        }
      });
    },0);
  });
  markers.push(m);
  return m;
}

/* Groups/List */
function buildGroupList(){
  const sel=document.getElementById('groupSel'); const set=new Set();
  DATA.forEach(r=>{const g=(r.Group||r.group||'').trim(); if(g) set.add(g)});
  GROUPS=Array.from(set).sort();
  sel.innerHTML=''; GROUPS.forEach(g=>{const o=document.createElement('option'); o.value=g; o.textContent=g; sel.appendChild(o)});
}
function updateList(){
  const list=document.getElementById('schoolList'); list.innerHTML='';
  const items=[];
  markers.forEach(m=>{const r=m._rec; if(visiblePredicate(r)) items.push({name:r.School||r.SchoolName||r.Name||'School',addr:r.Address||'',lat:r.lat,lon:r.lon,m})});
  items.sort((a,b)=>a.name.localeCompare(b.name));
  items.forEach(it=>{const d=document.createElement('div'); d.className='list-item'; d.innerHTML=`<strong>${it.name}</strong><br><span class="muted">${it.addr}</span>`; d.addEventListener('click',()=>{map.setView([it.lat,it.lon],14); it.m.fire('click')}); list.appendChild(d)});
}

/* Downloads */
function toCSV(rows, header){
  const esc=v=>'"'+String(v==null?'':v).replace(/"/g,'""')+'"';
  const lines=[header.map(esc).join(',')];
  rows.forEach(r=>lines.push(header.map(h=>esc(r[h])).join(',')));
  return lines.join('\n');
}
function download(filename, text){
  const blob=new Blob([text],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 500);
}

/* Server call: status update only */
async function updateRowInSheet({ keyField, keyValue, patch }){
  const res = await fetchWithTimeout(WRITE_ENDPOINT, {
    method: 'POST',
    headers: { 'Content-Type':'text/plain;charset=utf-8' }, // simple request (no preflight)
    body: JSON.stringify({ secret: WRITE_SECRET, mode:'update', sheetName: SHEET_TAB_NAME, keyField, keyValue, patch }),
    cache: 'no-store', redirect: 'follow'
  }, 15000);

  const text = await res.text();
  let json={}; try{ json=JSON.parse(text);}catch(e){ log('update non-JSON body: '+text.slice(0,200)); }
  if (!res.ok || !json.ok){
    log(`update FAIL http=${res.status} body=${text.slice(0,240)}`);
    throw new Error((json && json.error) || ('HTTP '+res.status));
  }
  return json;
}

/* Init */
async function init(){
  log('init → territories');
  await loadTerritories();

  const params = new URLSearchParams(location.search);
  const file   = (params.get('file')||'').replace(/[^a-z0-9._-]/gi,'');
  let csvUrl   = SHEETS_ENDPOINT;
  if (file) csvUrl += (csvUrl.includes('?') ? '&' : '?') + 'file=' + file;
  const host = new URL(csvUrl, location.href).host;
  if (!/googleusercontent\.com$/i.test(host) && !/script\.google\.com$/i.test(host)) {
    csvUrl += (csvUrl.includes('?') ? '&' : '?') + 'v=' + Date.now();
  }

  log('init → fetch CSV');
  const res  = await fetchWithTimeout(csvUrl, { cache: 'no-store', redirect: 'follow' }, 15000);
  if (!res.ok) throw new Error(`CSV HTTP ${res.status}`);
  const text = await res.text();

  const parsed=parseCSV(text); HEADER=parsed.header; DATA=parsed.rows; normalizeRecords(DATA);
  buildGroupList();

  log('init → create markers');
  for (let i=0;i<DATA.length;i++){
    const r=DATA[i];
    if(isValidLatLon(r.lat,r.lon)){
      const m = addCircleFor(r);
      if (visiblePredicate(r)) m.addTo(map); // hidden until territory selection
    }
  }
  log('init ← done');
}

/* Wire UI */
document.addEventListener('DOMContentLoaded',()=>{
  init().catch(e=>{console.error(e); showToast('Data load error: '+e.message, 'error'); log('ERR '+e.message)});

  document.getElementById('territorySel').addEventListener('change', onTerritoryChange);
  document.getElementById('groupSel').addEventListener('change', updateFilter);
  document.querySelectorAll('.statusChk').forEach(cb=>cb.addEventListener('change', updateFilter));
  document.getElementById('btnSearch').addEventListener('click', updateFilter);
  document.getElementById('btnClearSearch').addEventListener('click',()=>{document.getElementById('searchBox').value=''; updateFilter()});
  document.getElementById('searchBox').addEventListener('keydown',e=>{if(e.key==='Enter') updateFilter()});
  document.getElementById('btnZoomFirst').addEventListener('click',()=>{const first=markers.find(m=>map.hasLayer(m)); if(first) map.setView(first.getLatLng(),14)});

  document.getElementById('btnToggleList').addEventListener('click',()=>{
    LIST_ON=!LIST_ON;
    document.getElementById('listContainer').style.display=LIST_ON?'block':'none';
    document.getElementById('btnToggleList').textContent=LIST_ON?'List View: ON':'List View: OFF';
    if(LIST_ON) updateList();
  });
  document.getElementById('groupSelectAll').addEventListener('click',()=>{const s=document.getElementById('groupSel'); for(const o of s.options) o.selected=true; updateFilter()});
  document.getElementById('groupClear').addEventListener('click',()=>{const s=document.getElementById('groupSel'); for(const o of s.options) o.selected=false; updateFilter()});
});
</script>
</body>
</html>
